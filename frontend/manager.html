<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Enterprise Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(99, 102, 241, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar h1 {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logout-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        .section {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.15);
        }

        .section h2 {
            color: #f1f5f9;
            margin-bottom: 20px;
            font-size: 1.3rem;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .label {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }

        th {
            background: rgba(30, 41, 59, 0.9);
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        td {
            color: #e2e8f0;
        }

        tr:hover td {
            background: rgba(59, 130, 246, 0.05);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .status-approved {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            margin: 3px;
        }

        .btn-approve {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(30, 41, 59, 0.5);
            padding: 8px;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 0.9rem;
            font-weight: 600;
            color: #94a3b8;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #e2e8f0;
            background: rgba(59, 130, 246, 0.1);
        }

        .tab.active {
            color: #fff;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: #e2e8f0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }


        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            color: #1a202c;
        }

        .card h3 {
            color: #1a202c;
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .card p {
            color: #2d3748;
            margin: 8px 0;
            line-height: 1.6;
        }

        .card strong {
            color: #1a202c;
            font-weight: 700;
        }

        .card a {
            color: #3b82f6;
            text-decoration: none;
            word-break: break-all;
        }

        .card a:hover {
            text-decoration: underline;
        }

        .card.warning {
            border-left-color: #f39c12;
        }

        .card.danger {
            border-left-color: #e74c3c;
        }

        .card.success {
            border-left-color: #27ae60;
        }

        @media (max-width: 1024px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1>üëî Manager Dashboard - Enterprise Edition</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('timesheets')">üìã Timesheets</button>
            <button class="tab" onclick="switchTab('tasks')">‚úÖ Task Reviews</button>
            <button class="tab" onclick="switchTab('projects')">üì¶ Projects</button>
            <button class="tab" onclick="switchTab('attendance')">üïê Attendance</button>
            <button class="tab" onclick="switchTab('leaves')">üèñÔ∏è Leave Requests</button>
            <button class="tab" onclick="switchTab('meetings')">üìÖ Meetings</button>
            <button class="tab" onclick="switchTab('feedback')">üí¨ Feedback</button>
            <button class="tab" onclick="switchTab('analytics')">üìä Analytics</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports to Admin</button>
            <button class="tab" onclick="switchTab('profile')">üë§ Profile</button>
        </div>

        <!-- TAB 1: TIMESHEETS -->
        <div id="tab-timesheets" class="tab-content active">
            <!-- WORKFLOW 3: Manager Approval -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="teamCount">0</div>
                    <div class="label">Team Members</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="pendingCount">0</div>
                    <div class="label">Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="approvedCount">0</div>
                    <div class="label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalHours">0</div>
                    <div class="label">Team Hours</div>
                </div>
            </div>

            <!-- Additional Stats Cards Row -->
            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="number" id="proofCompletionCount">0</div>
                    <div class="label">üìÑ Proof Completions</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="number" id="totalTimesheetsCount">0</div>
                    <div class="label">üìù Total Timesheets</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="number" id="attendanceCount">0</div>
                    <div class="label">‚úÖ Attendance Records</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="number" id="leaveCount">0</div>
                    <div class="label">üèñÔ∏è Leave Requests</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="number" id="meetingAttendeesCount">0</div>
                    <div class="label">üë• Meeting Attendees</div>
                </div>
            </div>

            <div class="section">
                <h2>üìã Pending Timesheets for Approval</h2>
                <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Employee</label>
                        <select id="filterTimesheetEmployee" onchange="applyTimesheetFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Status</label>
                        <select id="filterTimesheetStatus" onchange="applyTimesheetFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="pending_manager">Pending Manager</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">From Date</label>
                        <input type="date" id="filterTimesheetFrom" onchange="applyTimesheetFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">To Date</label>
                        <input type="date" id="filterTimesheetTo" onchange="applyTimesheetFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">&nbsp;</label>
                        <button class="btn btn-reject" onclick="clearTimesheetFilters()"
                            style="padding: 8px 15px;">Clear Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Date</th>
                            <th>Project</th>
                            <th>Hours</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pendingList">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2: TASK REVIEWS -->
        <div id="tab-tasks" class="tab-content">
            <div class="section">
                <h2>‚úÖ Task Completion Reviews</h2>
                <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Employee</label>
                        <select id="filterTaskEmployee" onchange="applyTaskFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Status</label>
                        <select id="filterTaskStatus" onchange="applyTaskFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Status</option>
                            <option value="pending_review">Pending Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="rework_required">Rework Required</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Search Task</label>
                        <input type="text" id="filterTaskSearch" oninput="applyTaskFilters()"
                            placeholder="Search task title..."
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px; width: 200px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">&nbsp;</label>
                        <button class="btn btn-reject" onclick="clearTaskFilters()" style="padding: 8px 15px;">Clear
                            Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Task</th>
                            <th>GitHub Link</th>
                            <th>Video Link</th>
                            <th>Notes</th>
                            <th>Submitted</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="taskReviewsList">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3: PROJECTS -->
        <div id="tab-projects" class="tab-content">
            <div class="section">
                <h2>üì¶ My Projects - Completion Management</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    Submit completion proof for your projects. Admin will review and approve or request rework if
                    needed.
                </p>

                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Projects</div>
                        <div class="number" id="totalProjectsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Review</div>
                        <div class="number" id="pendingReviewCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rework Required</div>
                        <div class="number" id="reworkRequiredCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Approved</div>
                        <div class="number" id="approvedProjectsCount">0</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Review Status</th>
                            <th>Defects</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="projectsList">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 4: ATTENDANCE -->
        <div id="tab-attendance" class="tab-content">
            <div class="section">
                <h2>üïê Team Attendance Today</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-approve" onclick="loadTodayAttendance()">üîÑ Refresh Today</button>
                </div>

                <h3 style="margin-top: 20px; color: #27ae60;">‚úì Present (<span id="presentCount">0</span>)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Hours</th>
                            <th>Status</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody id="presentList">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="margin-top: 30px; color: #e74c3c;">‚úó Absent (<span id="absentCount">0</span>)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Email</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="absentList">
                        <tr>
                            <td colspan="3" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üîß Pending Correction Requests</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Date</th>
                            <th>Original</th>
                            <th>Requested</th>
                            <th>Reason</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="correctionsList">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 4: LEAVE REQUESTS -->
        <div id="tab-leaves" class="tab-content">
            <div class="section">
                <h2>üèñÔ∏è Pending Leave Requests</h2>
                <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Employee</label>
                        <select id="filterLeaveEmployee" onchange="applyLeaveFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Leave Type</label>
                        <select id="filterLeaveType" onchange="applyLeaveFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Types</option>
                            <option value="CL">Casual Leave (CL)</option>
                            <option value="SL">Sick Leave (SL)</option>
                            <option value="EL">Earned Leave (EL)</option>
                            <option value="WFH">Work From Home (WFH)</option>
                            <option value="PERMISSION">Permission</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Status</label>
                        <select id="filterLeaveStatus" onchange="applyLeaveFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">&nbsp;</label>
                        <button class="btn btn-reject" onclick="clearLeaveFilters()" style="padding: 8px 15px;">Clear
                            Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Type</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Days/Hours</th>
                            <th>Reason</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="leaveRequestsList">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 5: MEETINGS -->
        <div id="tab-meetings" class="tab-content">
            <div class="section">
                <h2>üìÖ Upcoming Meetings</h2>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-approve" onclick="showCreateMeetingModal()">+ Create Meeting</button>
                </div>
                <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Status</label>
                        <select id="filterMeetingStatus" onchange="applyMeetingFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Status</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">From Date</label>
                        <input type="date" id="filterMeetingFrom" onchange="applyMeetingFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">To Date</label>
                        <input type="date" id="filterMeetingTo" onchange="applyMeetingFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Search</label>
                        <input type="text" id="filterMeetingSearch" oninput="applyMeetingFilters()"
                            placeholder="Search title..."
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px; width: 180px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">&nbsp;</label>
                        <button class="btn btn-reject" onclick="clearMeetingFilters()" style="padding: 8px 15px;">Clear
                            Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Scheduled Time</th>
                            <th>Participants</th>
                            <th>Link</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="meetingsList">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 6: FEEDBACK -->
        <div id="tab-feedback" class="tab-content">
            <div class="section">
                <h2>üí¨ Feedback Threads</h2>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-approve" onclick="showCreateThreadModal()">+ New Thread</button>
                </div>
                <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Category</label>
                        <select id="filterFeedbackCategory" onchange="applyFeedbackFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Categories</option>
                            <option value="General">General</option>
                            <option value="Bug">Bug</option>
                            <option value="Issue">Issue</option>
                            <option value="Performance">Performance</option>
                            <option value="Request">Request</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Priority</label>
                        <select id="filterFeedbackPriority" onchange="applyFeedbackFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Priorities</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Status</label>
                        <select id="filterFeedbackStatus" onchange="applyFeedbackFilters()"
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px;">
                            <option value="">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">Search</label>
                        <input type="text" id="filterFeedbackSearch" oninput="applyFeedbackFilters()"
                            placeholder="Search subject..."
                            style="padding: 8px; border: 1px solid #ecf0f1; border-radius: 5px; width: 180px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; margin-bottom: 3px;">&nbsp;</label>
                        <button class="btn btn-reject" onclick="clearFeedbackFilters()" style="padding: 8px 15px;">Clear
                            Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Thread ID</th>
                            <th>Subject</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Participants</th>
                            <th>Last Message</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackThreadsList">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 7: ANALYTICS -->
        <div class="stats-grid">
            <!-- TAB 7: ANALYTICS -->
            <div id="tab-analytics" class="tab-content">
                <!-- FILTERS SECTION -->
                <div class="section"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h2 style="color: white; margin-bottom: 20px;">üîç Advanced Analytics Filters & Export</h2>

                    <!-- Primary Filters -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üë§
                                Employee</label>
                            <select id="filterAnalyticsEmployee" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üìÇ
                                Project</label>
                            <select id="filterAnalyticsProject" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">All Projects</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üìã
                                Task</label>
                            <select id="filterAnalyticsTask" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">All Tasks</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">‚úÖ
                                Status</label>
                            <select id="filterAnalyticsStatus" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="pending">Pending</option>
                                <option value="pending_manager">Pending Manager</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="locked">Locked</option>
                            </select>
                        </div>
                    </div>

                    <!-- Date & Range Filters -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üìÖ
                                From Date</label>
                            <input type="date" id="filterAnalyticsFrom" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üìÖ To
                                Date</label>
                            <input type="date" id="filterAnalyticsTo" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üìä
                                Quick Range</label>
                            <select id="filterAnalyticsQuickRange" onchange="applyQuickDateRange()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">Custom</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="this_week">This Week</option>
                                <option value="last_week">Last Week</option>
                                <option value="this_month">This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="last_7_days">Last 7 Days</option>
                                <option value="last_30_days">Last 30 Days</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="this_year">This Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üè¢
                                Department</label>
                            <select id="filterAnalyticsDepartment" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">All Departments</option>
                                <option value="IT">IT</option>
                                <option value="HR">HR</option>
                                <option value="Sales">Sales</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Finance">Finance</option>
                                <option value="Operations">Operations</option>
                            </select>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">‚è∞ Min
                                Hours</label>
                            <input type="number" id="filterAnalyticsMinHours" min="0" step="0.5" placeholder="Min"
                                onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">‚è∞ Max
                                Hours</label>
                            <input type="number" id="filterAnalyticsMaxHours" min="0" step="0.5" placeholder="Max"
                                onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">‚è±Ô∏è
                                Overtime Filter</label>
                            <select id="filterAnalyticsOvertime" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="">All</option>
                                <option value="with">With Overtime</option>
                                <option value="without">Without Overtime</option>
                                <option value="high">High Overtime (>5h)</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold;">üìà
                                Sort By</label>
                            <select id="filterAnalyticsSort" onchange="applyAnalyticsFilters()"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; background: white; color: #333;">
                                <option value="date_desc">Date (Newest First)</option>
                                <option value="date_asc">Date (Oldest First)</option>
                                <option value="hours_desc">Hours (High to Low)</option>
                                <option value="hours_asc">Hours (Low to High)</option>
                                <option value="employee">Employee Name</option>
                                <option value="project">Project Name</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button onclick="clearAnalyticsFilters()" class="btn"
                            style="background: white; color: #667eea; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">üîÑ
                            Clear All Filters</button>
                        <button onclick="applyAnalyticsFilters()" class="btn"
                            style="background: #8b5cf6; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üîç
                            Apply Filters</button>
                        <button onclick="downloadAnalyticsXLSX()" class="btn"
                            style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üì•
                            Download XLSX</button>
                        <button onclick="downloadAnalyticsCSV()" class="btn"
                            style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üìÑ
                            Download CSV</button>
                        <button onclick="downloadAnalyticsPDF()" class="btn"
                            style="background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üìë
                            Generate PDF</button>
                        <button onclick="sendAnalyticsToAdmin()" class="btn"
                            style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üì§
                            Send to Admin</button>
                        <button onclick="scheduleReport()" class="btn"
                            style="background: #ec4899; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚è∞
                            Schedule Report</button>
                        <button onclick="printAnalytics()" class="btn"
                            style="background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üñ®Ô∏è
                            Print</button>
                    </div>

                    <!-- Filter Summary -->
                    <div id="filterSummary"
                        style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 6px; display: none;">
                        <strong>Active Filters:</strong> <span id="filterSummaryText"></span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="sumTotal">0</div>
                        <div class="label">Total Timesheets</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="sumHours">0h</div>
                        <div class="label">Total Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="sumOvertime">0h</div>
                        <div class="label">Overtime Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="sumEmployees">0</div>
                        <div class="label">Active Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="sumProjects">0</div>
                        <div class="label">Active Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="avgHoursPerDay">0h</div>
                        <div class="label">Avg Hours/Day</div>
                    </div>
                </div>

                <!-- Hours Calculation Info -->
                <div
                    style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">‚è±Ô∏è</span>
                        <h3 style="margin: 0;">How Work Hours are Calculated</h3>
                    </div>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 14px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                            <strong>üìã From Timesheets</strong>
                            <p style="margin: 8px 0 0 0; opacity: 0.95;">All hours are calculated from employee
                                timesheet entries with start time, end time, and break duration.</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                            <strong>üßÆ Calculation Formula</strong>
                            <p style="margin: 8px 0 0 0; opacity: 0.95; font-family: monospace;">Total Hours = (End Time
                                - Start Time) - Break Minutes</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                            <strong>‚ö° Overtime</strong>
                            <p style="margin: 8px 0 0 0; opacity: 0.95;">Hours beyond 8h/day are automatically tracked
                                as overtime in timesheet records.</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                            <strong>‚úÖ Data Accuracy</strong>
                            <p style="margin: 8px 0 0 0; opacity: 0.95;">Only approved/pending timesheets are included.
                                Draft or rejected entries are excluded.</p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Analytics - 5 Enhanced Charts</h2>
                    <div class="chart-grid">
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>1Ô∏è‚É£ Hours by Project</h3>
                            <div class="chart-container">
                                <canvas id="byProject"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>2Ô∏è‚É£ Hours by Task</h3>
                            <div class="chart-container">
                                <canvas id="byTask"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>3Ô∏è‚É£ Timesheets by Status</h3>
                            <div class="chart-container">
                                <canvas id="byStatus"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>4Ô∏è‚É£ Hours Per Day (30-day)</h3>
                            <div class="chart-container">
                                <canvas id="hoursPerDay"></canvas>
                            </div>
                        </div>
                        <div
                            style="grid-column: 1 / 2; background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>5Ô∏è‚É£ Employee Utilization</h3>
                            <div class="chart-container">
                                <canvas id="empUtil"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Additional Analytics Charts -->
                <div class="section">
                    <h2>üìà Detailed Analytics - By Category</h2>
                    <div class="chart-grid">
                        <!-- Proof Completion Charts -->
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üìÑ Proof Completion by Employee</h3>
                            <div class="chart-container">
                                <canvas id="proofByEmployee"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üìÑ Proof Completion by Project</h3>
                            <div class="chart-container">
                                <canvas id="proofByProject"></canvas>
                            </div>
                        </div>

                        <!-- Timesheet Charts -->
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üìù Timesheets by Employee</h3>
                            <div class="chart-container">
                                <canvas id="timesheetByEmployee"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üìù Timesheets by Project</h3>
                            <div class="chart-container">
                                <canvas id="timesheetByProject"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üìù Timesheets by Task</h3>
                            <div class="chart-container">
                                <canvas id="timesheetByTask"></canvas>
                            </div>
                        </div>

                        <!-- Attendance Charts -->
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>‚úÖ Attendance by Employee</h3>
                            <div class="chart-container">
                                <canvas id="attendanceByEmployee"></canvas>
                            </div>
                        </div>

                        <!-- Leave Charts -->
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üèñÔ∏è Leave Requests by Employee</h3>
                            <div class="chart-container">
                                <canvas id="leaveByEmployee"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üèñÔ∏è Leave by Type</h3>
                            <div class="chart-container">
                                <canvas id="leaveByType"></canvas>
                            </div>
                        </div>

                        <!-- Meeting Charts -->
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üë• Meeting Attendees by Employee</h3>
                            <div class="chart-container">
                                <canvas id="meetingByEmployee"></canvas>
                            </div>
                        </div>
                        <div
                            style="background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #1e293b;">
                            <h3>üìÖ Meetings by Project</h3>
                            <div class="chart-container">
                                <canvas id="meetingByProject"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 8: REPORTS TO ADMIN -->
        <div id="tab-reports" class="tab-content">
            <div class="section">
                <h2>üìà Analytics Reports to Admin</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    Generate comprehensive analytics reports and send them to admin for performance review.
                </p>

                <button onclick="openCreateReportModal()"
                    style="background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-bottom: 20px;">
                    ‚ûï Create New Report
                </button>

                <div id="reportsContainer">
                    <p style="text-align: center; color: #95a5a6; padding: 40px;">Loading reports...</p>
                </div>
            </div>
        </div>

        <!-- TAB 10: PROFILE -->
        <div id="tab-profile" class="tab-content">
            <div class="section">
                <h2>üë§ My Profile</h2>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-top: 20px;">
                    <!-- Profile Card -->
                    <div
                        style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 30px; border-radius: 16px; text-align: center; color: white;">
                        <div
                            style="width: 120px; height: 120px; border-radius: 50%; background: white; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                            <span id="profileAvatar">üë§</span>
                        </div>
                        <h2 id="profileName" style="margin-bottom: 10px;">Loading...</h2>
                        <p id="profileRole" style="opacity: 0.9; text-transform: capitalize; font-size: 18px;">-</p>
                        <p id="profileDepartment" style="opacity: 0.8; margin-top: 5px;">-</p>
                        <p id="profileEmail" style="opacity: 0.7; margin-top: 10px; font-size: 14px;">-</p>
                    </div>

                    <!-- Profile Edit Form -->
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 16px;">
                        <h3 style="color: #f1f5f9; margin-bottom: 20px;">‚úèÔ∏è Update Profile</h3>
                        <form id="profileForm" onsubmit="updateProfile(event)">
                            <div class="form-group">
                                <label style="color: #94a3b8;">Full Name</label>
                                <input type="text" id="editName" placeholder="Your full name"
                                    style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="color: #94a3b8;">Phone Number</label>
                                    <input type="tel" id="editPhone" placeholder="+91 1234567890"
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                </div>
                                <div class="form-group">
                                    <label style="color: #94a3b8;">Date of Birth</label>
                                    <input type="date" id="editDOB"
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: #94a3b8;">Address</label>
                                <input type="text" id="editAddress" placeholder="Your address"
                                    style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="color: #94a3b8;">Designation</label>
                                    <input type="text" id="editDesignation" placeholder="e.g., Senior Manager"
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                </div>
                                <div class="form-group">
                                    <label style="color: #94a3b8;">Department</label>
                                    <input type="text" id="editDepartment" readonly
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2); opacity: 0.6;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="color: #94a3b8;">GitHub Profile</label>
                                    <input type="url" id="editGithub" placeholder="https://github.com/username"
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                </div>
                                <div class="form-group">
                                    <label style="color: #94a3b8;">LinkedIn Profile</label>
                                    <input type="url" id="editLinkedin" placeholder="https://linkedin.com/in/username"
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: #94a3b8;">Bio / About</label>
                                <textarea id="editBio" rows="3" placeholder="Tell us about yourself..."
                                    style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);"></textarea>
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 15px;">
                                <button type="submit" class="btn btn-approve" style="flex: 1;">üíæ Save Changes</button>
                                <button type="button" class="btn btn-reject" onclick="loadProfile()" style="flex: 0;">üîÑ
                                    Reset</button>
                            </div>
                        </form>

                        <!-- Change Password Section -->
                        <div
                            style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(59, 130, 246, 0.3);">
                            <h3 style="color: #f1f5f9; margin-bottom: 15px;">üîê Change Password</h3>
                            <form id="passwordForm" onsubmit="changePassword(event)">
                                <div class="form-group">
                                    <label style="color: #94a3b8;">Current Password</label>
                                    <input type="password" id="currentPassword" placeholder="Enter current password"
                                        required
                                        style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="color: #94a3b8;">New Password</label>
                                        <input type="password" id="newPassword" placeholder="Min 6 characters" required
                                            minlength="6"
                                            style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                    </div>
                                    <div class="form-group">
                                        <label style="color: #94a3b8;">Confirm Password</label>
                                        <input type="password" id="confirmPassword" placeholder="Confirm new password"
                                            required
                                            style="background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid rgba(59, 130, 246, 0.2);">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-approve">üîê Update Password</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Review Task -->
        <div id="reviewTaskModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Review Task Completion</h2>
                    <button class="modal-close" onclick="closeReviewTaskModal()">√ó</button>
                </div>
                <div id="reviewTaskContent"></div>
            </div>
        </div>

        <!-- MODAL: Create Meeting -->
        <div id="createMeetingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Meeting</h2>
                    <button class="modal-close" onclick="closeCreateMeetingModal()">√ó</button>
                </div>
                <form id="createMeetingForm" onsubmit="createMeeting(event)">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Scheduled Time *</label>
                        <input type="datetime-local" name="scheduledTime" required>
                    </div>
                    <div class="form-group">
                        <label>Meeting Link *</label>
                        <input type="url" name="link" placeholder="https://zoom.us/j/..." required>
                        <small style="color: #7f8c8d;">Zoom, Google Meet, Teams, Webex, or GoToMeeting</small>
                    </div>
                    <div class="form-group">
                        <label>Participants</label>
                        <div
                            style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; background: #f9f9f9;">
                            <div id="meetingParticipantsList" style="display: flex; flex-direction: column; gap: 5px;">
                                <p style="text-align: center; color: #999;">Loading participants...</p>
                            </div>
                        </div>
                        <small style="color: #7f8c8d;">As Manager, you can only invite employees</small>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-approve">Create Meeting</button>
                        <button type="button" class="btn btn-reject" onclick="closeCreateMeetingModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: Create Thread -->
        <div id="createThreadModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create Feedback Thread</h2>
                    <button class="modal-close" onclick="closeCreateThreadModal()">√ó</button>
                </div>
                <form id="createThreadForm" onsubmit="createThread(event)">
                    <div class="form-group">
                        <label>Recipients * <small id="recipientHelpText" style="color: #7f8c8d;"></small></label>
                        <div id="recipientsList"
                            style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                            <p style="color: #95a5a6;">Loading recipients...</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Subject *</label>
                        <input type="text" name="subject" required>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="category" required>
                            <option value="General">General</option>
                            <option value="Bug">Bug</option>
                            <option value="Issue">Issue</option>
                            <option value="Performance">Performance</option>
                            <option value="Request">Request</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority *</label>
                        <select name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Message *</label>
                        <textarea name="message" required></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-approve">Create Thread</button>
                        <button type="button" class="btn btn-reject" onclick="closeCreateThreadModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Thread Modal -->
        <div id="viewThreadModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close-btn" onclick="closeViewThread()">&times;</span>
                <h2 id="viewThreadTitle">Thread</h2>
                <div id="viewThreadParticipants" style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;"></div>

                <div
                    style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px; background: #fff; border: 1px solid #ecf0f1; border-radius: 5px;">
                    <div id="threadMessagesContainer"></div>
                </div>

                <div style="border-top: 2px solid #ecf0f1; padding-top: 15px;">
                    <h3 style="margin-bottom: 10px;">Reply</h3>
                    <textarea id="replyMessage" rows="4"
                        style="width: 100%; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; font-family: inherit;"
                        placeholder="Type your reply..."></textarea>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button type="button" class="btn btn-approve" onclick="sendReply()">Send Reply</button>
                        <button type="button" class="btn btn-reject" onclick="closeViewThread()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Create Analytics Report -->
        <div id="createReportModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>üìä Create Analytics Report</h2>
                    <button class="modal-close" onclick="closeCreateReportModal()">√ó</button>
                </div>
                <form id="createReportForm" onsubmit="createAnalyticsReport(event)">
                    <div class="form-group">
                        <label>Report Title *</label>
                        <input type="text" name="title" required placeholder="e.g., Q4 Team Performance Report">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" rows="3" placeholder="Brief description of this report"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Report Type *</label>
                        <select name="reportType" required>
                            <option value="team_performance">Team Performance</option>
                            <option value="project_status">Project Status</option>
                            <option value="timesheet_summary">Timesheet Summary</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Range *</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 12px; color: #7f8c8d;">Start Date</label>
                                <input type="date" name="startDate" required>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #7f8c8d;">End Date</label>
                                <input type="date" name="endDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-approve">‚úì Generate & Send to Admin</button>
                        <button type="button" class="btn btn-reject" onclick="closeCreateReportModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: View Report Details -->
        <div id="viewReportModal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h2>üìä Report Details</h2>
                    <button class="modal-close" onclick="closeViewReportModal()">√ó</button>
                </div>
                <div id="reportDetailsContainer">
                    <p style="text-align: center; color: #95a5a6; padding: 40px;">Loading report details...</p>
                </div>
            </div>
        </div>

        <script>
            const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
            if (!token) window.location.href = '/login.html';

            // Verify manager role
            async function checkManagerAccess() {
                try {
                    const res = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await res.json();
                    if (!res.ok || (data.user?.role !== 'manager' && data.user?.role !== 'admin')) {
                        alert('Access denied. Manager access only.');
                        window.location.href = '/login.html';
                    }
                } catch (err) {
                    alert('Authentication failed');
                    window.location.href = '/login.html';
                }
            }
            checkManagerAccess();

            let currentTab = 'timesheets';

            // Tab Switching
            function switchTab(tabName) {
                currentTab = tabName;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');

                // Load data for the active tab
                switch (tabName) {
                    case 'timesheets':
                        loadTimesheets();
                        break;
                    case 'tasks':
                        loadTaskReviews();
                        break;
                    case 'projects':
                        loadProjects();
                        break;
                    case 'attendance':
                        loadTodayAttendance();
                        loadCorrections();
                        break;
                    case 'leaves':
                        loadLeaveRequests();
                        break;
                    case 'meetings':
                        loadMeetings();
                        break;
                    case 'feedback':
                        loadFeedbackThreads();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                    case 'reports':
                        loadMyReports();
                        break;
                    case 'profile':
                        loadProfile();
                        break;
                }
            }

            async function api(path, options = {}) {
                const res = await fetch(`/api${path}`, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                if (res.status === 401) {
                    localStorage.clear();
                    window.location.href = '/login.html';
                    return;
                }
                return res.json();
            }

            // TIMESHEETS
            async function loadTimesheets() {
                try {
                    const pending = await api('/timesheets/pending');
                    const allResponse = await api('/timesheets');
                    const all = allResponse?.data || allResponse || [];
                    allTimesheets = all.length > 0 ? all : (pending || []);
                    renderTimesheets(allTimesheets);

                    const summary = await api('/analysis/summary');
                    document.getElementById('pendingCount').textContent = summary?.pending || 0;
                    document.getElementById('approvedCount').textContent = summary?.approved || 0;
                    document.getElementById('totalHours').textContent = (summary?.totalHours || 0).toFixed(1);

                    const employees = await api('/admin/employees');
                    document.getElementById('teamCount').textContent = employees?.length || 0;

                    // Load additional stats
                    await loadAdditionalStats();
                } catch (e) {
                    console.error('Error loading timesheets:', e);
                    document.getElementById('pendingList').innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">‚ùå</div><div>Error loading timesheets: ' + e.message + '</div></td></tr>';
                }
            }

            // Load Additional Statistics
            async function loadAdditionalStats() {
                try {
                    console.log('üìä Loading additional statistics...');

                    // Proof Completions Count
                    try {
                        const proofs = await api('/project-completion/proofs');
                        console.log('Proof response:', proofs);
                        const proofsArray = Array.isArray(proofs) ? proofs : (proofs?.data || []);
                        const proofCount = proofsArray.length;
                        document.getElementById('proofCompletionCount').textContent = proofCount;
                        console.log('‚úÖ Proof completions:', proofCount);
                    } catch (e) {
                        console.error('‚ùå Error loading proofs:', e);
                        document.getElementById('proofCompletionCount').textContent = '0';
                    }

                    // Total Timesheets Count
                    try {
                        const timesheets = await api('/timesheets');
                        console.log('Timesheet response:', timesheets);
                        const timesheetsArray = timesheets?.data || timesheets || [];
                        const timesheetCount = Array.isArray(timesheetsArray) ? timesheetsArray.length : 0;
                        document.getElementById('totalTimesheetsCount').textContent = timesheetCount;
                        console.log('‚úÖ Total timesheets:', timesheetCount);
                    } catch (e) {
                        console.error('‚ùå Error loading timesheets:', e);
                        document.getElementById('totalTimesheetsCount').textContent = '0';
                    }

                    // Attendance Count
                    try {
                        const attendance = await api('/attendance');
                        console.log('Attendance response:', attendance);
                        const attendanceArray = attendance?.data || [];
                        const attendanceCount = Array.isArray(attendanceArray) ? attendanceArray.length : 0;
                        document.getElementById('attendanceCount').textContent = attendanceCount;
                        console.log('‚úÖ Attendance records:', attendanceCount);
                    } catch (e) {
                        console.error('‚ùå Error loading attendance:', e);
                        document.getElementById('attendanceCount').textContent = '0';
                    }

                    // Leave Requests Count
                    try {
                        const leaves = await api('/leave/all');
                        console.log('Leave response:', leaves);
                        const leavesArray = leaves?.data || [];
                        const leaveCount = Array.isArray(leavesArray) ? leavesArray.length : 0;
                        document.getElementById('leaveCount').textContent = leaveCount;
                        console.log('‚úÖ Leave requests:', leaveCount);
                    } catch (e) {
                        console.error('‚ùå Error loading leaves:', e);
                        document.getElementById('leaveCount').textContent = '0';
                    }

                    // Meeting Attendees Count
                    try {
                        const meetings = await api('/meetings');
                        console.log('Meetings response:', meetings);
                        const meetingsArray = Array.isArray(meetings) ? meetings : (meetings?.data || []);
                        console.log('Meetings array length:', meetingsArray.length);

                        // Count unique attendees across all meetings
                        const uniqueAttendees = new Set();
                        meetingsArray.forEach(meeting => {
                            // Handle recipients array (people invited to meeting)
                            if (meeting.recipients && Array.isArray(meeting.recipients)) {
                                meeting.recipients.forEach(recipient => {
                                    const id = recipient?._id || recipient;
                                    if (id) uniqueAttendees.add(String(id));
                                });
                            }
                            // Also handle attendees array if it exists
                            if (meeting.attendees && Array.isArray(meeting.attendees)) {
                                meeting.attendees.forEach(attendee => {
                                    const id = attendee?._id || attendee;
                                    if (id) uniqueAttendees.add(String(id));
                                });
                            }
                        });

                        const attendeeCount = uniqueAttendees.size;
                        document.getElementById('meetingAttendeesCount').textContent = attendeeCount;
                        console.log('‚úÖ Unique meeting attendees:', attendeeCount);
                    } catch (e) {
                        console.error('‚ùå Error loading meetings:', e);
                        document.getElementById('meetingAttendeesCount').textContent = '0';
                    }

                    console.log('‚úÖ Additional stats loaded successfully');
                } catch (e) {
                    console.error('Error loading additional stats:', e);
                }
            }

            async function approveTimesheet(id) {
                if (!confirm('Approve this timesheet?')) return;

                try {
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        alert('‚ùå Not authenticated. Please login again.');
                        window.location.href = '/login.html';
                        return;
                    }

                    console.log('Approving timesheet:', id);
                    const res = await fetch(`/api/timesheets/${id}/approve`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            approve: true
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Timesheet Approved!');
                        loadTimesheets();
                    } else {
                        const error = await res.json().catch(() => ({
                            message: 'Unknown error'
                        }));
                        alert('‚ùå Error: ' + (error.message || 'Failed to approve'));
                        console.error('Approve error:', error);
                    }
                } catch (err) {
                    console.error('Approve exception:', err);
                    alert('‚ùå Error approving timesheet: ' + err.message);
                }
            }

            async function rejectTimesheet(id) {
                const reason = prompt('Reason for rejection (optional):');
                if (reason === null) return; // User cancelled

                try {
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        alert('‚ùå Not authenticated. Please login again.');
                        window.location.href = '/login.html';
                        return;
                    }

                    console.log('Rejecting timesheet:', id);
                    const res = await fetch(`/api/timesheets/${id}/approve`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            approve: false,
                            remarks: reason
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Timesheet Rejected!');
                        loadTimesheets();
                    } else {
                        const error = await res.json().catch(() => ({
                            message: 'Unknown error'
                        }));
                        alert('‚ùå Error: ' + (error.message || 'Failed to reject'));
                        console.error('Reject error:', error);
                    }
                } catch (err) {
                    console.error('Reject exception:', err);
                    alert('‚ùå Error rejecting timesheet: ' + err.message);
                }
            }

            // TASK REVIEWS
            async function loadTaskReviews() {
                try {
                    const response = await api('/task-completion/pending-reviews');
                    allTasks = response.data || response || [];
                    renderTasks(allTasks);
                } catch (e) {
                    console.error('Error loading task reviews:', e);
                    document.getElementById('taskReviewsList').innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚ùå</div><div>Error loading reviews</div></td></tr>';
                }
            }

            function openReviewTaskModal(taskId, employeeId) {
                document.getElementById('reviewTaskContent').innerHTML = `
                <div class="form-group">
                    <label>Defect Description *</label>
                    <textarea id="defectDescription" placeholder="Describe what needs to be fixed..." required></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-reject" onclick="reviewTask('${taskId}', '${employeeId}', 'reject')">Reject with Defects</button>
                    <button class="btn" onclick="closeReviewTaskModal()">Cancel</button>
                </div>
            `;
                document.getElementById('reviewTaskModal').classList.add('show');
            }

            function closeReviewTaskModal() {
                document.getElementById('reviewTaskModal').classList.remove('show');
            }

            async function sendForRework(taskId, employeeId) {
                const defectDescription = prompt('Enter defects found and rework required:\n(Be specific about what needs to be fixed)');

                if (!defectDescription || !defectDescription.trim()) {
                    alert('‚ùå Defect description is required');
                    return;
                }

                if (!confirm('Send this task back for rework?\n\nThe employee will be notified and can resubmit after fixing the issues.')) {
                    return;
                }

                try {
                    const token = localStorage.getItem('auth_token');
                    const res = await fetch('/api/task-completion/review', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            taskId,
                            employeeId,
                            action: 'rework',
                            defectDescription: defectDescription.trim()
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Task sent for rework! Employee has been notified.');
                        loadTaskReviews();
                    } else {
                        const error = await res.json().catch(() => ({
                            message: 'Unknown error'
                        }));
                        alert('‚ùå Error: ' + (error.message || 'Failed to send for rework'));
                    }
                } catch (err) {
                    console.error('Send for rework error:', err);
                    alert('‚ùå Error: ' + err.message);
                }
            }

            async function reviewTask(taskId, employeeId, action) {
                if (action === 'approve') {
                    // Direct approval without modal
                    const token = localStorage.getItem('auth_token');
                    const res = await fetch('/api/task-completion/review', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            taskId,
                            employeeId,
                            action: 'approve'
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Task Approved! Employee notified.');
                        loadTaskReviews();
                    } else {
                        const error = await res.json();
                        alert('Error: ' + error.message);
                    }
                } else if (action === 'reject') {
                    // Check if called from modal or button
                    const defectDescription = document.getElementById('defectDescription')?.value;

                    if (!defectDescription) {
                        // Open modal for reject
                        openReviewTaskModal(taskId, employeeId);
                        return;
                    }

                    if (!defectDescription.trim()) {
                        alert('Please provide defect description');
                        return;
                    }

                    const token = localStorage.getItem('auth_token');
                    const res = await fetch('/api/task-completion/review', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            taskId,
                            employeeId,
                            action: 'reject',
                            defectDescription
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Task rejected. Employee notified to rework.');
                        closeReviewTaskModal();
                        loadTaskReviews();
                    } else {
                        const error = await res.json();
                        alert('Error: ' + error.message);
                    }
                }
            }

            // ATTENDANCE
            async function loadTodayAttendance() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const response = await api(`/attendance/team/all?date=${today}`);
                    const data = response?.data || response;
                    const summary = response?.summary || {};

                    // Present employees
                    let presentHtml = '';
                    const presentList = data?.present || [];
                    presentList.forEach(att => {
                        const checkIn = att.checkInTime ? new Date(att.checkInTime).toLocaleTimeString() : '-';
                        const checkOut = att.checkOutTime ? new Date(att.checkOutTime).toLocaleTimeString() : '-';
                        const hours = att.totalHours ? att.totalHours.toFixed(2) : '0';
                        const status = att.isLate ? '‚ö†Ô∏è Late' : '‚úì On Time';
                        const statusClass = att.isLate ? 'badge-warning' : 'badge-success';

                        presentHtml += `<tr>
                        <td>${att.employee?.name || 'Unknown'}</td>
                        <td>${checkIn}</td>
                        <td>${checkOut}</td>
                        <td>${hours}h</td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                        <td>${att.location || 'office'}</td>
                    </tr>`;
                    });
                    document.getElementById('presentList').innerHTML = presentHtml || '<tr><td colspan="6" class="empty-state">No employees checked in</td></tr>';
                    document.getElementById('presentCount').textContent = summary.present || 0;

                    // Absent employees
                    let absentHtml = '';
                    const absentList = data?.absent || [];
                    absentList.forEach(emp => {
                        const empData = emp.employee || emp;
                        absentHtml += `<tr>
                        <td>${empData.name}</td>
                        <td>${empData.email}</td>
                        <td><span class="badge badge-danger">Absent</span></td>
                    </tr>`;
                    });
                    document.getElementById('absentList').innerHTML = absentHtml || '<tr><td colspan="3" class="empty-state">All employees present!</td></tr>';
                    document.getElementById('absentCount').textContent = summary.absent || 0;
                } catch (e) {
                    console.error('Error loading attendance:', e);
                    document.getElementById('presentList').innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">‚ùå</div><div>Error: ' + e.message + '</div></td></tr>';
                }
            }

            async function loadCorrections() {
                try {
                    const response = await api('/attendance/corrections/pending');
                    const corrections = response?.data || [];

                    let html = '';
                    corrections.forEach(att => {
                        const employeeName = att.employee?.name || att.employee?.email || 'Unknown';
                        const date = new Date(att.date).toLocaleDateString();
                        const originalCheckIn = att.checkInTime ? new Date(att.checkInTime).toLocaleTimeString() : '-';
                        const originalCheckOut = att.checkOutTime ? new Date(att.checkOutTime).toLocaleTimeString() : '-';
                        const requestedCheckIn = att.correctionRequest?.requestedCheckIn ? new Date(att.correctionRequest.requestedCheckIn).toLocaleTimeString() : '-';
                        const requestedCheckOut = att.correctionRequest?.requestedCheckOut ? new Date(att.correctionRequest.requestedCheckOut).toLocaleTimeString() : '-';
                        const reason = att.correctionRequest?.reason || '-';

                        html += `<tr>
                            <td>${employeeName}</td>
                            <td>${date}</td>
                            <td>In: ${originalCheckIn}<br>Out: ${originalCheckOut}</td>
                            <td>In: ${requestedCheckIn}<br>Out: ${requestedCheckOut}</td>
                            <td style="max-width:200px;">${reason}</td>
                            <td>
                                <button class="btn btn-approve btn-sm" onclick="approveCorrection('${att._id}')">‚úì Approve</button>
                                <button class="btn btn-reject btn-sm" onclick="rejectCorrection('${att._id}')">‚úó Reject</button>
                            </td>
                        </tr>`;
                    });

                    document.getElementById('correctionsList').innerHTML = html || '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No pending correction requests</div></td></tr>';
                } catch (e) {
                    console.error('Error loading corrections:', e);
                    document.getElementById('correctionsList').innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">‚ùå</div><div>Error loading corrections</div></td></tr>';
                }
            }

            async function approveCorrection(id) {
                if (!confirm('Approve this attendance correction request?')) return;

                try {
                    const token = localStorage.getItem('auth_token');
                    const res = await fetch(`/api/attendance/corrections/${id}/approve`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (res.ok) {
                        alert('‚úÖ Correction approved!');
                        loadCorrections();
                        loadTodayAttendance();
                    } else {
                        const error = await res.json().catch(() => ({
                            message: 'Unknown error'
                        }));
                        alert('‚ùå Error: ' + (error.message || 'Failed to approve'));
                    }
                } catch (err) {
                    console.error('Approve correction error:', err);
                    alert('‚ùå Error: ' + err.message);
                }
            }

            async function rejectCorrection(id) {
                const reason = prompt('Reason for rejection (optional):');
                if (reason === null) return; // User cancelled

                try {
                    const token = localStorage.getItem('auth_token');
                    const res = await fetch(`/api/attendance/corrections/${id}/reject`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            reason
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Correction rejected!');
                        loadCorrections();
                    } else {
                        const error = await res.json().catch(() => ({
                            message: 'Unknown error'
                        }));
                        alert('‚ùå Error: ' + (error.message || 'Failed to reject'));
                    }
                } catch (err) {
                    console.error('Reject correction error:', err);
                    alert('‚ùå Error: ' + err.message);
                }
            }

            // LEAVE REQUESTS
            async function loadLeaveRequests() {
                try {
                    const pendingResponse = await api('/leave/pending');
                    const allResponse = await api('/leave/all');
                    const pending = pendingResponse?.data || pendingResponse || [];
                    const all = allResponse?.data || allResponse || [];
                    allLeaves = all.length > 0 ? all : pending;
                    renderLeaves(allLeaves);
                } catch (e) {
                    console.error('Error loading leave requests:', e);
                    document.getElementById('leaveRequestsList').innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚ùå</div><div>Error: ' + e.message + '</div></td></tr>';
                }
            }

            async function approveLeave(id) {
                if (confirm('Approve this leave request?\n\nThis will deduct from employee\'s leave balance.')) {
                    const res = await fetch(`/api/leave/approve/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await res.json();
                    if (res.ok) {
                        alert('‚úÖ Leave Approved!\n\n' + data.message);
                        loadLeaveRequests();
                    } else {
                        alert('‚ùå Error: ' + data.message);
                    }
                }
            }

            async function rejectLeave(id) {
                const reason = prompt('Rejection reason:');
                if (reason) {
                    const res = await fetch(`/api/leave/reject/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            rejectionReason: reason
                        })
                    });
                    if (res.ok) {
                        alert('‚úÖ Leave Rejected');
                        loadLeaveRequests();
                    }
                }
            }

            // MEETINGS
            async function loadMeetings() {
                try {
                    console.log('üìû Loading meetings...');
                    const response = await fetch('/api/meetings-v2/list', { // Remove status filter to show ALL meetings
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    allMeetings = data.data || data || [];
                    console.log(`üìû Loaded ${allMeetings.length} meetings`);
                    renderMeetings(allMeetings);
                } catch (e) {
                    console.error('‚ùå Error loading meetings:', e);
                    document.getElementById('meetingsList').innerHTML =
                        `<tr><td colspan="6" style="text-align:center;color:#e74c3c;">Error: ${e.message}</td></tr>`;
                }
            }

            async function showCreateMeetingModal() {
                document.getElementById('createMeetingModal').classList.add('show');
                await loadParticipantsForMeeting();
            }

            async function loadParticipantsForMeeting() {
                try {
                    console.log('üë• Loading participants for meeting...');

                    // Get current user info
                    const userRes = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const userData = await userRes.json();
                    const currentUser = userData.user || userData;

                    // Manager can only invite employees
                    const rolesToFetch = currentUser.role === 'admin' ? 'manager,employee' : 'employee';

                    const res = await fetch(`/api/users/by-role?roles=${rolesToFetch}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await res.json();
                    const users = data.data || [];

                    console.log(`üë• Loaded ${users.length} potential participants`);

                    const participantsList = document.getElementById('meetingParticipantsList');
                    if (!participantsList) return;

                    if (users.length === 0) {
                        participantsList.innerHTML = '<p style="text-align: center; color: #999;">No users available</p>';
                    } else {
                        participantsList.innerHTML = users.map(user => `
                            <label style="display: flex; align-items: center; gap: 8px; padding: 5px; cursor: pointer; border-radius: 4px;"
                                   onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" name="participant" value="${user._id}" style="cursor: pointer;">
                                <span style="flex: 1;">
                                    <strong>${user.name}</strong>
                                    <small style="color: #666; display: block;">${user.role} - ${user.department || 'N/A'}</small>
                                </span>
                            </label>
                        `).join('');
                    }
                } catch (err) {
                    console.error('‚ùå Error loading participants:', err);
                }
            }

            function closeCreateMeetingModal() {
                document.getElementById('createMeetingModal').classList.remove('show');
                document.getElementById('createMeetingForm').reset();
            }

            async function createMeeting(event) {
                event.preventDefault();
                try {
                    const formData = new FormData(event.target);

                    // Get selected participants
                    const participantCheckboxes = document.querySelectorAll('input[name="participant"]:checked');
                    const participants = Array.from(participantCheckboxes).map(cb => cb.value);

                    console.log('üìû Creating meeting with', participants.length, 'participants');

                    const scheduledTime = formData.get('scheduledTime');
                    const data = {
                        title: formData.get('title'),
                        agenda: formData.get('description'),
                        startTime: new Date(scheduledTime).toISOString(),
                        location: formData.get('link'),
                        duration: 60,
                        meetingType: 'other',
                        participants: participants
                    };

                    const res = await fetch('/api/meetings-v2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await res.json();

                    if (res.ok) {
                        alert(`‚úÖ Meeting Created with ${participants.length} participants!`);
                        closeCreateMeetingModal();
                        loadMeetings();
                    } else {
                        throw new Error(result.message || 'Failed to create meeting');
                    }
                } catch (error) {
                    console.error('‚ùå Error creating meeting:', error);
                    alert('Error: ' + error.message);
                }
            }

            async function viewAttendance(meetingId) {
                const data = await api(`/meetings-v2/${meetingId}/attendance`);
                let msg = `Meeting Attendance Report\n\n`;
                msg += `Total Invited: ${data.totalInvited}\n`;
                msg += `Total Joined: ${data.totalJoined}\n`;
                msg += `No Shows: ${data.noShows}\n`;
                msg += `Attendance Rate: ${data.attendanceRate}%\n\n`;
                msg += `Participants:\n`;
                data.participants.forEach(p => {
                    msg += `- ${p.attendee?.name || 'Unknown'}: ${p.status} (${p.duration || 0} min)\n`;
                });
                alert(msg);
            }

            async function cancelMeeting(meetingId) {
                if (confirm('Cancel this meeting?')) {
                    const res = await fetch(`/api/meetings-v2/${meetingId}/cancel`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (res.ok) {
                        alert('‚úÖ Meeting Cancelled');
                        loadMeetings();
                    } else {
                        alert('Error cancelling meeting');
                    }
                }
            }

            // FEEDBACK THREADS
            async function loadFeedbackThreads() {
                try {
                    console.log('üìã Loading feedback threads...');
                    const response = await api('/feedback-threads/threads/all');
                    console.log('üìã Response:', response);

                    const threads = response.data || response || [];
                    console.log('üìã Threads count:', threads.length);

                    allFeedback = threads;
                    renderFeedback(allFeedback);
                } catch (e) {
                    console.error('‚ùå Error loading feedback threads:', e);
                    document.getElementById('feedbackThreadsList').innerHTML =
                        '<tr><td colspan="7" style="text-align:center;color:#e74c3c;">Error loading threads: ' + e.message + '</td></tr>';
                }
            }

            async function showCreateThreadModal() {
                document.getElementById('createThreadModal').classList.add('show');

                // Load recipients based on user role
                try {
                    const userRes = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const userData = await userRes.json();
                    const currentUser = userData.user || userData;

                    let helpText = '';
                    if (currentUser.role === 'employee') {
                        helpText = 'You can only send to Managers';
                    } else if (currentUser.role === 'manager') {
                        helpText = 'You can send to Admins and Employees';
                    } else if (currentUser.role === 'admin') {
                        helpText = 'You can send to Managers and Employees';
                    }
                    document.getElementById('recipientHelpText').textContent = helpText;

                    const res = await fetch('/api/feedback-threads/recipients', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await res.json();
                    const recipients = data.data || [];

                    const recipientsList = document.getElementById('recipientsList');
                    if (recipients.length === 0) {
                        recipientsList.innerHTML = '<p style="color: #e74c3c;">No recipients available</p>';
                    } else {
                        recipientsList.innerHTML = recipients.map(user => `
                            <label style="display: flex; align-items: center; gap: 8px; padding: 5px; cursor: pointer;">
                                <input type="checkbox" name="recipient" value="${user._id}" style="cursor: pointer;">
                                <span><strong>${user.name}</strong> <small style="color: #7f8c8d;">(${user.role}${user.department ? ' - ' + user.department : ''})</small></span>
                            </label>
                        `).join('');
                    }
                } catch (err) {
                    console.error('Error loading recipients:', err);
                    document.getElementById('recipientsList').innerHTML = '<p style="color: #e74c3c;">Error loading recipients</p>';
                }
            }

            function closeCreateThreadModal() {
                document.getElementById('createThreadModal').classList.remove('show');
                document.getElementById('createThreadForm').reset();
            }

            async function createThread(event) {
                event.preventDefault();
                const formData = new FormData(event.target);

                // Get selected recipients
                const recipientCheckboxes = document.querySelectorAll('input[name="recipient"]:checked');
                const recipients = Array.from(recipientCheckboxes).map(cb => cb.value);

                if (recipients.length === 0) {
                    alert('‚ùå Please select at least one recipient');
                    return;
                }

                const data = {
                    subject: formData.get('subject'),
                    category: formData.get('category'),
                    priority: formData.get('priority'),
                    message: formData.get('message'),
                    recipients: recipients
                };

                console.log('üì© Creating thread with data:', data);

                const res = await fetch('/api/feedback-threads/thread/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    alert(`‚úÖ Thread Created with ${recipients.length} recipient(s)!`);
                    closeCreateThreadModal();
                    loadFeedbackThreads();
                } else {
                    alert('‚ùå Error: ' + result.message);
                    console.error('Create thread error:', result);
                }
            }

            let currentThreadId = null;

            async function viewThread(threadId) {
                try {
                    currentThreadId = threadId;
                    const response = await api(`/feedback-threads/thread/${threadId}/messages`);
                    const messages = response.data || response || [];

                    // Get thread details from the list
                    const thread = allFeedback.find(t => t._id === threadId);

                    document.getElementById('viewThreadTitle').textContent = thread?.title || 'Thread';
                    document.getElementById('viewThreadParticipants').textContent =
                        `From: ${thread?.sender?.name || 'Unknown'} | To: ${thread?.receiver?.name || 'Unknown'}`;

                    let html = '';
                    if (messages.length === 0) {
                        html = '<div style="text-align:center;color:#7f8c8d;padding:20px;">No messages yet</div>';
                    } else {
                        messages.forEach(m => {
                            html += `
                                <div style="padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #3498db;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <strong style="color: #2c3e50;">${m.sender?.name || 'Unknown'}</strong>
                                        <span style="color: #7f8c8d; font-size: 12px;">${new Date(m.createdAt).toLocaleString()}</span>
                                    </div>
                                    <div style="color: #34495e;">${m.message}</div>
                                </div>
                            `;
                        });
                    }
                    document.getElementById('threadMessagesContainer').innerHTML = html;

                    // Show modal
                    document.getElementById('viewThreadModal').classList.add('show');
                } catch (err) {
                    console.error('Error viewing thread:', err);
                    alert('Error loading thread messages');
                }
            }

            function closeViewThread() {
                document.getElementById('viewThreadModal').classList.remove('show');
                currentThreadId = null;
                document.getElementById('replyMessage').value = '';
            }

            async function sendReply() {
                const message = document.getElementById('replyMessage').value.trim();
                if (!message) {
                    alert('Please enter a message');
                    return;
                }

                try {
                    const res = await fetch(`/api/feedback-threads/thread/${currentThreadId}/reply`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message
                        })
                    });

                    if (!res.ok) throw new Error('Failed to send reply');

                    document.getElementById('replyMessage').value = '';
                    // Reload messages
                    await viewThread(currentThreadId);
                } catch (err) {
                    console.error('Error sending reply:', err);
                    alert('Error sending reply');
                }
            }

            // ANALYTICS
            // Store chart instances
            let chartInstances = {};

            // Force global defaults for all Chart versions (Light Theme -> Black Text)
            if (Chart.defaults) {
                Chart.defaults.color = '#000000';
                Chart.defaults.borderColor = 'rgba(0,0,0,0.1)';
                if (Chart.defaults.global) {
                    Chart.defaults.global.defaultFontColor = '#000000';
                }
                if (Chart.defaults.plugins && Chart.defaults.plugins.legend) {
                    Chart.defaults.plugins.legend.labels.color = '#000000';
                }
                // Force scale/axis colors
                if (Chart.defaults.scale) {
                    if (Chart.defaults.scale.ticks) {
                        Chart.defaults.scale.ticks.color = '#000000';
                        Chart.defaults.scale.ticks.fontColor = '#000000';
                    }
                }
                if (Chart.defaults.scales) {
                    if (Chart.defaults.scales.category && Chart.defaults.scales.category.ticks) Chart.defaults.scales.category.ticks.color = '#000000';
                    if (Chart.defaults.scales.linear && Chart.defaults.scales.linear.ticks) Chart.defaults.scales.linear.ticks.color = '#000000';
                }
            }

            function drawChart(canvasId, type, labels, data, title) {
                try {
                    // Destroy existing chart if it exists
                    if (chartInstances[canvasId]) {
                        chartInstances[canvasId].destroy();
                    }

                    const ctx = document.getElementById(canvasId).getContext('2d');

                    // Define basic options with legend config (Global Theme: Black Text)
                    const options = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#000000',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    };

                    // Add scales only for Bar and Line charts (Cartesian) - Light Theme Colors
                    if (type === 'bar' || type === 'line') {
                        options.scales = {
                            x: {
                                ticks: {
                                    color: '#000000',
                                    font: { weight: 'bold' }
                                },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            },
                            y: {
                                ticks: {
                                    color: '#000000',
                                    font: { weight: 'bold' }
                                },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        };
                    }

                    chartInstances[canvasId] = new Chart(ctx, {
                        type: type,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: title,
                                data: data,
                                backgroundColor: ['#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c', '#34495e', '#e67e22'],
                                borderColor: ['#2980b9', '#229954', '#d68910', '#c0392b', '#8e44ad', '#16a085', '#2c3e50', '#d35400'],
                                borderWidth: 1
                            }]
                        },
                        options: options
                    });
                } catch (e) {
                    console.error('Chart error:', e);
                }
            }

            async function loadAnalytics() {
                try {
                    // Fetch all data and cache it
                    const [summary, timesheets, projects, employees, tasks] = await Promise.all([
                        api('/analysis/summary'),
                        api('/timesheets'),
                        api('/projects'),
                        api('/admin/employees').catch(() => []),
                        api('/tasks')
                    ]);

                    // Store in global analyticsData
                    analyticsData.timesheets = timesheets?.data || timesheets || [];
                    analyticsData.projects = projects?.data || projects || [];
                    analyticsData.employees = employees?.data || employees || [];
                    analyticsData.tasks = tasks?.data || tasks || [];
                    analyticsData.filteredData = analyticsData.timesheets;

                    // Update initial stats
                    document.getElementById('sumTotal').textContent = summary.totalTimesheets;
                    document.getElementById('sumHours').textContent = summary.totalHours.toFixed(1) + 'h';
                    document.getElementById('sumOvertime').textContent = summary.totalOvertimeHours.toFixed(1) + 'h';

                    // Calculate additional stats
                    const uniqueEmployees = new Set(analyticsData.timesheets.map(ts => String(ts.employee?._id || ts.employee))).size;
                    const uniqueProjects = new Set(analyticsData.timesheets.map(ts => String(ts.project?._id || ts.project))).size;
                    const avgHoursPerDay = analyticsData.timesheets.length > 0 ?
                        (summary.totalHours / analyticsData.timesheets.length).toFixed(1) : 0;

                    document.getElementById('sumEmployees').textContent = uniqueEmployees;
                    document.getElementById('sumProjects').textContent = uniqueProjects;
                    document.getElementById('avgHoursPerDay').textContent = avgHoursPerDay + 'h';

                    // Load charts - ensure data is array
                    const byProject = await api('/analysis/chart/by-project');
                    const byProjectData = Array.isArray(byProject) ? byProject : (byProject.data || []);
                    drawChart('byProject', 'bar',
                        byProjectData.map(p => p._id || 'Unassigned'),
                        byProjectData.map(p => p.totalHours),
                        'Hours by Project'
                    );

                    const byTask = await api('/analysis/chart/by-task');
                    const byTaskData = Array.isArray(byTask) ? byTask : (byTask.data || []);
                    drawChart('byTask', 'doughnut',
                        byTaskData.map(t => t._id || 'Unassigned'),
                        byTaskData.map(t => t.totalHours),
                        'Hours by Task'
                    );

                    const byStatus = await api('/analysis/chart/by-status');
                    const byStatusData = Array.isArray(byStatus) ? byStatus : (byStatus.data || []);
                    drawChart('byStatus', 'pie',
                        byStatusData.map(s => s._id),
                        byStatusData.map(s => s.count),
                        'Timesheets by Status'
                    );

                    const hoursPerDay = await api('/analysis/chart/hours-per-day');
                    const hoursPerDayData = Array.isArray(hoursPerDay) ? hoursPerDay : (hoursPerDay.data || []);
                    drawChart('hoursPerDay', 'line',
                        hoursPerDayData.map(h => h._id),
                        hoursPerDayData.map(h => h.totalHours),
                        'Hours Per Day'
                    );

                    const empUtil = await api('/analysis/chart/employee-utilization');
                    const empUtilData = Array.isArray(empUtil) ? empUtil : (empUtil.data || []);
                    drawChart('empUtil', 'bar',
                        empUtilData.map(e => e._id),
                        empUtilData.map(e => e.totalHours),
                        'Employee Utilization'
                    );

                    // Populate filter dropdowns
                    await populateAnalyticsFilters();

                    // Load additional detailed charts
                    await loadDetailedAnalyticsCharts();
                } catch (e) {
                    console.error('Error loading analytics:', e);
                    alert('Error loading analytics: ' + e.message);
                }
            }

            // Load Detailed Analytics Charts
            async function loadDetailedAnalyticsCharts() {
                try {
                    console.log('üìä Loading detailed analytics charts...');

                    // 1. Proof Completion by Employee
                    try {
                        const proofs = await api('/project-completion/proofs');
                        console.log('üìä Proof data for charts:', proofs);
                        const proofsArray = Array.isArray(proofs) ? proofs : (proofs?.data || []);
                        console.log('üìä Proofs array length:', proofsArray.length);

                        if (proofsArray.length > 0) {
                            const proofByEmp = {};
                            proofsArray.forEach(proof => {
                                const empName = proof.submittedBy?.name || proof.employee?.name || 'Unknown';
                                proofByEmp[empName] = (proofByEmp[empName] || 0) + 1;
                            });

                            const labels = Object.keys(proofByEmp);
                            const data = Object.values(proofByEmp);

                            if (labels.length > 0) {
                                drawChart('proofByEmployee', 'bar', labels, data, 'Proof Completions by Employee');
                                console.log('‚úÖ Proof by employee chart created with', labels.length, 'employees');
                            } else {
                                drawChart('proofByEmployee', 'bar', ['No Data'], [0], 'Proof Completions by Employee');
                            }
                        } else {
                            drawChart('proofByEmployee', 'bar', ['No Data'], [0], 'Proof Completions by Employee');
                            console.log('‚ö†Ô∏è No proof data available');
                        }
                    } catch (e) {
                        console.error('‚ùå Proof by employee chart error:', e);
                        drawChart('proofByEmployee', 'bar', ['No Data'], [0], 'Proof Completions by Employee');
                    }

                    // 2. Proof Completion by Project
                    try {
                        const proofs = await api('/project-completion/proofs');
                        const proofsArray = Array.isArray(proofs) ? proofs : (proofs?.data || []);

                        if (proofsArray.length > 0) {
                            const proofByProj = {};
                            proofsArray.forEach(proof => {
                                const projName = proof.project?.name || 'Unknown Project';
                                proofByProj[projName] = (proofByProj[projName] || 0) + 1;
                            });

                            const labels = Object.keys(proofByProj);
                            const data = Object.values(proofByProj);

                            if (labels.length > 0) {
                                drawChart('proofByProject', 'doughnut', labels, data, 'Proof Completions by Project');
                                console.log('‚úÖ Proof by project chart created with', labels.length, 'projects');
                            } else {
                                drawChart('proofByProject', 'doughnut', ['No Data'], [0], 'Proof Completions by Project');
                            }
                        } else {
                            drawChart('proofByProject', 'doughnut', ['No Data'], [0], 'Proof Completions by Project');
                        }
                    } catch (e) {
                        console.error('‚ùå Proof by project chart error:', e);
                        drawChart('proofByProject', 'doughnut', ['No Data'], [0], 'Proof Completions by Project');
                    }

                    // 3. Timesheets by Employee
                    const tsByEmp = {};
                    analyticsData.timesheets.forEach(ts => {
                        const empName = ts.employee?.name || 'Unknown';
                        tsByEmp[empName] = (tsByEmp[empName] || 0) + 1;
                    });
                    const topEmps = Object.entries(tsByEmp).sort((a, b) => b[1] - a[1]).slice(0, 10);
                    drawChart('timesheetByEmployee', 'bar',
                        topEmps.map(e => e[0]),
                        topEmps.map(e => e[1]),
                        'Timesheets by Employee (Top 10)'
                    );

                    // 4. Timesheets by Project
                    const tsByProj = {};
                    analyticsData.timesheets.forEach(ts => {
                        const projName = ts.project?.name || 'Unassigned';
                        tsByProj[projName] = (tsByProj[projName] || 0) + 1;
                    });
                    drawChart('timesheetByProject', 'doughnut',
                        Object.keys(tsByProj),
                        Object.values(tsByProj),
                        'Timesheets by Project'
                    );

                    // 5. Timesheets by Task
                    const tsByTask = {};
                    analyticsData.timesheets.forEach(ts => {
                        const taskName = ts.task?.title || ts.task?.name || 'Unassigned';
                        tsByTask[taskName] = (tsByTask[taskName] || 0) + 1;
                    });
                    const topTasks = Object.entries(tsByTask).sort((a, b) => b[1] - a[1]).slice(0, 10);
                    drawChart('timesheetByTask', 'bar',
                        topTasks.map(t => t[0]),
                        topTasks.map(t => t[1]),
                        'Timesheets by Task (Top 10)'
                    );

                    // 6. Attendance by Employee
                    try {
                        const attendance = await api('/attendance');
                        console.log('üìä Attendance data for chart:', attendance);
                        const attArray = attendance?.data || [];
                        console.log('üìä Attendance array length:', attArray.length);

                        if (attArray.length > 0) {
                            const attByEmp = {};
                            attArray.forEach(att => {
                                const empName = att.employee?.name || 'Unknown';
                                attByEmp[empName] = (attByEmp[empName] || 0) + 1;
                            });
                            const topAttEmps = Object.entries(attByEmp).sort((a, b) => b[1] - a[1]).slice(0, 10);

                            if (topAttEmps.length > 0) {
                                drawChart('attendanceByEmployee', 'bar',
                                    topAttEmps.map(e => e[0]),
                                    topAttEmps.map(e => e[1]),
                                    'Attendance by Employee (Top 10)'
                                );
                                console.log('‚úÖ Attendance chart created with', topAttEmps.length, 'employees');
                            } else {
                                drawChart('attendanceByEmployee', 'bar', ['No Data'], [0], 'Attendance by Employee');
                            }
                        } else {
                            drawChart('attendanceByEmployee', 'bar', ['No Data'], [0], 'Attendance by Employee');
                            console.log('‚ö†Ô∏è No attendance data available');
                        }
                    } catch (e) {
                        console.error('‚ùå Attendance chart error:', e);
                        drawChart('attendanceByEmployee', 'bar', ['No Data'], [0], 'Attendance by Employee');
                    }

                    // 7. Leave Requests by Employee
                    try {
                        const leaves = await api('/leave/all');
                        console.log('üìä Leave data for chart:', leaves);
                        const leavesArray = leaves?.data || [];
                        console.log('üìä Leave array length:', leavesArray.length);

                        if (leavesArray.length > 0) {
                            const leaveByEmp = {};
                            leavesArray.forEach(leave => {
                                const empName = leave.employee?.name || 'Unknown';
                                leaveByEmp[empName] = (leaveByEmp[empName] || 0) + 1;
                            });
                            const topLeaveEmps = Object.entries(leaveByEmp).sort((a, b) => b[1] - a[1]).slice(0, 10);

                            if (topLeaveEmps.length > 0) {
                                drawChart('leaveByEmployee', 'bar',
                                    topLeaveEmps.map(e => e[0]),
                                    topLeaveEmps.map(e => e[1]),
                                    'Leave Requests by Employee (Top 10)'
                                );
                                console.log('‚úÖ Leave by employee chart created with', topLeaveEmps.length, 'employees');
                            } else {
                                drawChart('leaveByEmployee', 'bar', ['No Data'], [0], 'Leave Requests by Employee');
                            }
                        } else {
                            drawChart('leaveByEmployee', 'bar', ['No Data'], [0], 'Leave Requests by Employee');
                            console.log('‚ö†Ô∏è No leave data available');
                        }
                    } catch (e) {
                        console.error('‚ùå Leave by employee chart error:', e);
                        drawChart('leaveByEmployee', 'bar', ['No Data'], [0], 'Leave Requests by Employee');
                    }

                    // 8. Leave by Type
                    try {
                        const leaves = await api('/leave/all');
                        const leavesArray = leaves?.data || [];

                        if (leavesArray.length > 0) {
                            const leaveByType = {};
                            leavesArray.forEach(leave => {
                                const type = leave.leaveType || 'Other';
                                leaveByType[type] = (leaveByType[type] || 0) + 1;
                            });

                            const labels = Object.keys(leaveByType);
                            const data = Object.values(leaveByType);

                            if (labels.length > 0) {
                                drawChart('leaveByType', 'pie', labels, data, 'Leave Requests by Type');
                                console.log('‚úÖ Leave by type chart created with', labels.length, 'types');
                            } else {
                                drawChart('leaveByType', 'pie', ['No Data'], [0], 'Leave Requests by Type');
                            }
                        } else {
                            drawChart('leaveByType', 'pie', ['No Data'], [0], 'Leave Requests by Type');
                        }
                    } catch (e) {
                        console.error('‚ùå Leave by type chart error:', e);
                        drawChart('leaveByType', 'pie', ['No Data'], [0], 'Leave Requests by Type');
                    }

                    // 9. Meeting Attendees by Employee
                    try {
                        const meetings = await api('/meetings');
                        console.log('üìä Meetings data for chart:', meetings);
                        const meetingsArray = Array.isArray(meetings) ? meetings : (meetings?.data || []);
                        console.log('üìä Meetings array length:', meetingsArray.length);

                        if (meetingsArray.length > 0) {
                            const attByEmp = {};
                            meetingsArray.forEach(meeting => {
                                // Check recipients (invited people)
                                if (meeting.recipients && Array.isArray(meeting.recipients)) {
                                    meeting.recipients.forEach(recipient => {
                                        const empName = recipient?.name || 'Unknown';
                                        attByEmp[empName] = (attByEmp[empName] || 0) + 1;
                                    });
                                }
                                // Also check attendees if available
                                if (meeting.attendees && Array.isArray(meeting.attendees)) {
                                    meeting.attendees.forEach(attendee => {
                                        const empName = attendee?.name || attendee?.employee?.name || 'Unknown';
                                        if (!attByEmp[empName]) {
                                            attByEmp[empName] = 1;
                                        }
                                    });
                                }
                            });

                            const topMeetingEmps = Object.entries(attByEmp).sort((a, b) => b[1] - a[1]).slice(0, 10);

                            if (topMeetingEmps.length > 0) {
                                drawChart('meetingByEmployee', 'bar',
                                    topMeetingEmps.map(e => e[0]),
                                    topMeetingEmps.map(e => e[1]),
                                    'Meeting Participation by Employee (Top 10)'
                                );
                                console.log('‚úÖ Meeting by employee chart created with', topMeetingEmps.length, 'employees');
                            } else {
                                drawChart('meetingByEmployee', 'bar', ['No Data'], [0], 'Meeting Participation by Employee');
                            }
                        } else {
                            drawChart('meetingByEmployee', 'bar', ['No Data'], [0], 'Meeting Participation by Employee');
                            console.log('‚ö†Ô∏è No meeting data available');
                        }
                    } catch (e) {
                        console.error('‚ùå Meeting by employee chart error:', e);
                        drawChart('meetingByEmployee', 'bar', ['No Data'], [0], 'Meeting Participation by Employee');
                    }

                    // 10. Meetings by Title
                    try {
                        const meetings = await api('/meetings');
                        const meetingsArray = Array.isArray(meetings) ? meetings : (meetings?.data || []);

                        if (meetingsArray.length > 0) {
                            const meetByTitle = {};
                            meetingsArray.forEach(meeting => {
                                const title = meeting.title || 'Untitled Meeting';
                                meetByTitle[title] = (meetByTitle[title] || 0) + 1;
                            });

                            // Get top 8 meetings by count
                            const topMeetings = Object.entries(meetByTitle)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 8);

                            if (topMeetings.length > 0) {
                                drawChart('meetingByProject', 'doughnut',
                                    topMeetings.map(m => m[0]),
                                    topMeetings.map(m => m[1]),
                                    'Meeting Distribution (Top 8)'
                                );
                                console.log('‚úÖ Meeting distribution chart created with', topMeetings.length, 'meetings');
                            } else {
                                drawChart('meetingByProject', 'doughnut', ['No Data'], [0], 'Meeting Distribution');
                            }
                        } else {
                            drawChart('meetingByProject', 'doughnut', ['No Data'], [0], 'Meeting Distribution');
                        }
                    } catch (e) {
                        console.error('‚ùå Meeting distribution chart error:', e);
                        drawChart('meetingByProject', 'doughnut', ['No Data'], [0], 'Meeting Distribution');
                    }

                    console.log('‚úÖ Detailed analytics charts loaded successfully');
                } catch (e) {
                    console.error('Error loading detailed charts:', e);
                }
            }

            // Store analytics data for filtering
            let analyticsData = {
                timesheets: [],
                employees: [],
                projects: [],
                tasks: [],
                filteredData: []
            };

            // Populate Analytics Filters
            async function populateAnalyticsFilters() {
                try {
                    // Get employees
                    const empResponse = await api('/admin/employees');
                    analyticsData.employees = empResponse?.data || empResponse || [];

                    const empOptions = analyticsData.employees.map(emp =>
                        `<option value="${emp._id}">${emp.name || emp.email}</option>`
                    ).join('');
                    document.getElementById('filterAnalyticsEmployee').innerHTML = '<option value="">All Employees</option>' + empOptions;

                    // Get projects
                    const projResponse = await api('/projects');
                    analyticsData.projects = projResponse?.data || projResponse || [];

                    const projOptions = analyticsData.projects.map(proj =>
                        `<option value="${proj._id}">${proj.name}</option>`
                    ).join('');
                    document.getElementById('filterAnalyticsProject').innerHTML = '<option value="">All Projects</option>' + projOptions;

                    // Get tasks
                    const taskResponse = await api('/tasks');
                    analyticsData.tasks = taskResponse?.data || taskResponse || [];

                    const taskOptions = analyticsData.tasks.map(task =>
                        `<option value="${task._id}">${task.title}</option>`
                    ).join('');
                    document.getElementById('filterAnalyticsTask').innerHTML = '<option value="">All Tasks</option>' + taskOptions;

                    // Get all timesheets for client-side filtering
                    const tsResponse = await api('/timesheets');
                    analyticsData.timesheets = tsResponse?.data || tsResponse || [];
                } catch (e) {
                    console.error('Error populating analytics filters:', e);
                }
            }

            // Quick Date Range Helper
            function applyQuickDateRange() {
                const range = document.getElementById('filterAnalyticsQuickRange').value;
                const today = new Date();
                let fromDate, toDate;

                switch (range) {
                    case 'today':
                        fromDate = toDate = today.toISOString().split('T')[0];
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        fromDate = toDate = yesterday.toISOString().split('T')[0];
                        break;
                    case 'this_week':
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        fromDate = weekStart.toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'last_week':
                        const lastWeekEnd = new Date(today);
                        lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                        const lastWeekStart = new Date(lastWeekEnd);
                        lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
                        fromDate = lastWeekStart.toISOString().split('T')[0];
                        toDate = lastWeekEnd.toISOString().split('T')[0];
                        break;
                    case 'this_month':
                        fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'last_month':
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        fromDate = lastMonth.toISOString().split('T')[0];
                        toDate = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().split('T')[0];
                        break;
                    case 'last_7_days':
                        const last7 = new Date(today);
                        last7.setDate(today.getDate() - 7);
                        fromDate = last7.toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'last_30_days':
                        const last30 = new Date(today);
                        last30.setDate(today.getDate() - 30);
                        fromDate = last30.toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'this_quarter':
                        const quarter = Math.floor(today.getMonth() / 3);
                        fromDate = new Date(today.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    case 'this_year':
                        fromDate = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
                        toDate = today.toISOString().split('T')[0];
                        break;
                    default:
                        return;
                }

                document.getElementById('filterAnalyticsFrom').value = fromDate;
                document.getElementById('filterAnalyticsTo').value = toDate;
                applyAnalyticsFilters();
            }

            // Apply Analytics Filters (Enhanced with all new filters)
            async function applyAnalyticsFilters() {
                try {
                    // Validate data is loaded
                    if (!analyticsData.timesheets || analyticsData.timesheets.length === 0) {
                        console.warn('No timesheet data loaded yet');
                        return;
                    }

                    const employeeId = document.getElementById('filterAnalyticsEmployee')?.value || '';
                    const fromDate = document.getElementById('filterAnalyticsFrom')?.value || '';
                    const toDate = document.getElementById('filterAnalyticsTo')?.value || '';
                    const projectId = document.getElementById('filterAnalyticsProject')?.value || '';
                    const taskId = document.getElementById('filterAnalyticsTask')?.value || '';
                    const status = document.getElementById('filterAnalyticsStatus')?.value || '';
                    const department = document.getElementById('filterAnalyticsDepartment')?.value || '';
                    const minHours = parseFloat(document.getElementById('filterAnalyticsMinHours')?.value) || 0;
                    const maxHours = parseFloat(document.getElementById('filterAnalyticsMaxHours')?.value) || Infinity;
                    const overtimeFilter = document.getElementById('filterAnalyticsOvertime')?.value || '';
                    const sortBy = document.getElementById('filterAnalyticsSort')?.value || 'date_desc';

                    // Validate date range
                    if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
                        alert('‚ö†Ô∏è From Date cannot be after To Date');
                        return;
                    }

                    // Validate hours range
                    if (minHours > maxHours && maxHours !== Infinity) {
                        alert('‚ö†Ô∏è Min Hours cannot be greater than Max Hours');
                        return;
                    }

                    // Client-side filtering for advanced criteria
                    let filtered = [...analyticsData.timesheets];
                    let filterCount = 0;

                    // Basic filters
                    if (employeeId) {
                        filtered = filtered.filter(ts => String(ts.employee?._id || ts.employee) === employeeId);
                        filterCount++;
                    }
                    if (projectId) {
                        filtered = filtered.filter(ts => String(ts.project?._id || ts.project) === projectId);
                        filterCount++;
                    }
                    if (taskId) {
                        filtered = filtered.filter(ts => String(ts.task?._id || ts.task) === taskId);
                        filterCount++;
                    }
                    if (status) {
                        filtered = filtered.filter(ts => ts.status === status);
                        filterCount++;
                    }
                    if (fromDate) {
                        filtered = filtered.filter(ts => new Date(ts.date) >= new Date(fromDate));
                        filterCount++;
                    }
                    if (toDate) {
                        filtered = filtered.filter(ts => new Date(ts.date) <= new Date(toDate));
                        filterCount++;
                    }

                    // Department filter (filter employees by department)
                    if (department) {
                        const deptEmployees = analyticsData.employees
                            .filter(emp => emp.department === department)
                            .map(emp => String(emp._id));
                        filtered = filtered.filter(ts => deptEmployees.includes(String(ts.employee?._id || ts.employee)));
                        filterCount++;
                    }

                    // Hours range filter
                    if (minHours > 0 || maxHours !== Infinity) {
                        filtered = filtered.filter(ts => {
                            const hours = ts.totalHours || 0;
                            return hours >= minHours && hours <= maxHours;
                        });
                        if (minHours > 0) filterCount++;
                        if (maxHours !== Infinity) filterCount++;
                    }

                    // Overtime filter
                    if (overtimeFilter === 'with') {
                        filtered = filtered.filter(ts => (ts.overtimeHours || 0) > 0);
                        filterCount++;
                    } else if (overtimeFilter === 'without') {
                        filtered = filtered.filter(ts => (ts.overtimeHours || 0) === 0);
                        filterCount++;
                    } else if (overtimeFilter === 'high') {
                        filtered = filtered.filter(ts => (ts.overtimeHours || 0) > 5);
                        filterCount++;
                    }

                    // Check if no results
                    if (filtered.length === 0 && filterCount > 0) {
                        // Show helpful debug info
                        const debugInfo = `
üìä Filter Debug Info:
- Total timesheets in database: ${analyticsData.timesheets.length}
- Filters applied: ${filterCount}
- Results after filtering: 0

üí° Suggestions:
1. Try reducing the number of filters
2. Use "Last 30 Days" for date range
3. Check if selected employee/project has timesheets
4. Click "Clear All Filters" to see all data

Available data:
- Employees with timesheets: ${new Set(analyticsData.timesheets.map(ts => ts.employee?.name || 'Unknown')).size}
- Projects with timesheets: ${new Set(analyticsData.timesheets.map(ts => ts.project?.name || 'Unknown')).size}
- Date range: ${analyticsData.timesheets.length > 0 ? new Date(Math.min(...analyticsData.timesheets.map(ts => new Date(ts.date)))).toLocaleDateString() : 'N/A'} to ${analyticsData.timesheets.length > 0 ? new Date(Math.max(...analyticsData.timesheets.map(ts => new Date(ts.date)))).toLocaleDateString() : 'N/A'}
                        `;
                        console.log(debugInfo);
                        alert(`‚ö†Ô∏è No timesheets found matching ${filterCount} filter(s).\n\nTotal available: ${analyticsData.timesheets.length} timesheets\n\nCheck browser console (F12) for details, or click "Clear All Filters" to see all data.`);
                    }

                    // Sorting
                    filtered.sort((a, b) => {
                        switch (sortBy) {
                            case 'date_desc':
                                return new Date(b.date) - new Date(a.date);
                            case 'date_asc':
                                return new Date(a.date) - new Date(b.date);
                            case 'hours_desc':
                                return (b.totalHours || 0) - (a.totalHours || 0);
                            case 'hours_asc':
                                return (a.totalHours || 0) - (b.totalHours || 0);
                            case 'employee':
                                return (a.employee?.name || '').localeCompare(b.employee?.name || '');
                            case 'project':
                                return (a.project?.name || '').localeCompare(b.project?.name || '');
                            default:
                                return 0;
                        }
                    });

                    analyticsData.filteredData = filtered;

                    // Update stats
                    const totalTimesheets = filtered.length;
                    const totalHours = filtered.reduce((sum, ts) => sum + (ts.totalHours || 0), 0);
                    const totalOvertime = filtered.reduce((sum, ts) => sum + (ts.overtimeHours || 0), 0);
                    const uniqueEmployees = new Set(filtered.map(ts => String(ts.employee?._id || ts.employee))).size;
                    const uniqueProjects = new Set(filtered.map(ts => String(ts.project?._id || ts.project))).size;
                    const avgHoursPerDay = totalTimesheets > 0 ? (totalHours / totalTimesheets).toFixed(1) : 0;

                    document.getElementById('sumTotal').textContent = totalTimesheets;
                    document.getElementById('sumHours').textContent = totalHours.toFixed(1) + 'h';
                    document.getElementById('sumOvertime').textContent = totalOvertime.toFixed(1) + 'h';
                    document.getElementById('sumEmployees').textContent = uniqueEmployees;
                    document.getElementById('sumProjects').textContent = uniqueProjects;
                    document.getElementById('avgHoursPerDay').textContent = avgHoursPerDay + 'h';

                    // Update charts with filtered data
                    updateChartsWithFilteredData(filtered);

                    // Show filter summary
                    updateFilterSummary(filterCount);

                    // Show success message if filters applied
                    if (filterCount > 0) {
                        console.log(`‚úÖ ${filterCount} filter(s) applied. Found ${filtered.length} timesheet(s).`);
                    }
                } catch (e) {
                    console.error('Error applying filters:', e);
                    alert('‚ùå Error applying filters: ' + e.message);
                }
            }

            // Update Charts with Filtered Data
            function updateChartsWithFilteredData(filtered) {
                try {
                    // Validate filtered data
                    if (!Array.isArray(filtered)) {
                        console.error('Invalid filtered data');
                        return;
                    }

                    // Chart 1: Hours by Project
                    const projectHours = {};
                    filtered.forEach(ts => {
                        const proj = ts.project?.name || 'Unassigned';
                        projectHours[proj] = (projectHours[proj] || 0) + (ts.totalHours || 0);
                    });

                    const projectLabels = Object.keys(projectHours);
                    const projectValues = Object.values(projectHours);

                    if (projectLabels.length > 0) {
                        drawChart('byProject', 'bar',
                            projectLabels,
                            projectValues,
                            'Hours by Project (Filtered)'
                        );
                    } else {
                        drawChart('byProject', 'bar', ['No Data'], [0], 'Hours by Project (Filtered)');
                    }

                    // Chart 2: Hours by Task
                    const taskHours = {};
                    filtered.forEach(ts => {
                        const task = ts.task?.title || ts.task?.name || 'Unassigned';
                        taskHours[task] = (taskHours[task] || 0) + (ts.totalHours || 0);
                    });

                    const taskLabels = Object.keys(taskHours);
                    const taskValues = Object.values(taskHours);

                    if (taskLabels.length > 0) {
                        drawChart('byTask', 'doughnut',
                            taskLabels,
                            taskValues,
                            'Hours by Task (Filtered)'
                        );
                    } else {
                        drawChart('byTask', 'doughnut', ['No Data'], [1], 'Hours by Task (Filtered)');
                    }

                    // Chart 3: Timesheets by Status
                    const statusCount = {};
                    filtered.forEach(ts => {
                        statusCount[ts.status] = (statusCount[ts.status] || 0) + 1;
                    });

                    const statusLabels = Object.keys(statusCount);
                    const statusValues = Object.values(statusCount);

                    if (statusLabels.length > 0) {
                        drawChart('byStatus', 'pie',
                            statusLabels,
                            statusValues,
                            'Timesheets by Status (Filtered)'
                        );
                    } else {
                        drawChart('byStatus', 'pie', ['No Data'], [1], 'Timesheets by Status (Filtered)');
                    }

                    // Chart 4: Hours Per Day
                    const dailyHours = {};
                    filtered.forEach(ts => {
                        const date = new Date(ts.date).toISOString().split('T')[0];
                        dailyHours[date] = (dailyHours[date] || 0) + (ts.totalHours || 0);
                    });
                    const sortedDates = Object.keys(dailyHours).sort().slice(-30);
                    const sortedValues = sortedDates.map(d => dailyHours[d]);

                    if (sortedDates.length > 0) {
                        drawChart('hoursPerDay', 'line',
                            sortedDates,
                            sortedValues,
                            'Hours Per Day (Last 30, Filtered)'
                        );
                    } else {
                        drawChart('hoursPerDay', 'line', ['No Data'], [0], 'Hours Per Day (Last 30, Filtered)');
                    }

                    // Chart 5: Employee Utilization
                    const empHours = {};
                    filtered.forEach(ts => {
                        const emp = ts.employee?.name || ts.employee?.email || 'Unknown';
                        empHours[emp] = (empHours[emp] || 0) + (ts.totalHours || 0);
                    });

                    const empLabels = Object.keys(empHours);
                    const empValues = Object.values(empHours);

                    if (empLabels.length > 0) {
                        drawChart('empUtil', 'bar',
                            empLabels,
                            empValues,
                            'Employee Utilization (Filtered)'
                        );
                    } else {
                        drawChart('empUtil', 'bar', ['No Data'], [0], 'Employee Utilization (Filtered)');
                    }
                } catch (e) {
                    console.error('Error updating charts:', e);
                }
            }

            // Update Filter Summary
            function updateFilterSummary(filterCount) {
                try {
                    const filters = [];
                    const empSelect = document.getElementById('filterAnalyticsEmployee');
                    const projSelect = document.getElementById('filterAnalyticsProject');
                    const taskSelect = document.getElementById('filterAnalyticsTask');
                    const statusSelect = document.getElementById('filterAnalyticsStatus');
                    const deptSelect = document.getElementById('filterAnalyticsDepartment');
                    const fromDate = document.getElementById('filterAnalyticsFrom').value;
                    const toDate = document.getElementById('filterAnalyticsTo').value;
                    const minHours = document.getElementById('filterAnalyticsMinHours').value;
                    const maxHours = document.getElementById('filterAnalyticsMaxHours').value;
                    const overtimeSelect = document.getElementById('filterAnalyticsOvertime');

                    if (empSelect?.value) filters.push(`Employee: ${empSelect.options[empSelect.selectedIndex].text}`);
                    if (projSelect?.value) filters.push(`Project: ${projSelect.options[projSelect.selectedIndex].text}`);
                    if (taskSelect?.value) filters.push(`Task: ${taskSelect.options[taskSelect.selectedIndex].text}`);
                    if (statusSelect?.value) filters.push(`Status: ${statusSelect.options[statusSelect.selectedIndex].text}`);
                    if (deptSelect?.value) filters.push(`Department: ${deptSelect.value}`);
                    if (fromDate) filters.push(`From: ${fromDate}`);
                    if (toDate) filters.push(`To: ${toDate}`);
                    if (minHours) filters.push(`Min Hours: ${minHours}`);
                    if (maxHours) filters.push(`Max Hours: ${maxHours}`);
                    if (overtimeSelect?.value) filters.push(`Overtime: ${overtimeSelect.options[overtimeSelect.selectedIndex].text}`);

                    const summaryDiv = document.getElementById('filterSummary');
                    const summaryText = document.getElementById('filterSummaryText');

                    if (filters.length > 0) {
                        summaryText.textContent = `${filters.length} Active Filter(s): ${filters.join(' | ')}`;
                        summaryDiv.style.display = 'block';
                    } else {
                        summaryDiv.style.display = 'none';
                    }
                } catch (e) {
                    console.error('Error updating filter summary:', e);
                }
            }

            // Clear Analytics Filters
            function clearAnalyticsFilters() {
                try {
                    document.getElementById('filterAnalyticsEmployee').value = '';
                    document.getElementById('filterAnalyticsFrom').value = '';
                    document.getElementById('filterAnalyticsTo').value = '';
                    document.getElementById('filterAnalyticsProject').value = '';
                    document.getElementById('filterAnalyticsTask').value = '';
                    document.getElementById('filterAnalyticsStatus').value = '';
                    document.getElementById('filterAnalyticsDepartment').value = '';
                    document.getElementById('filterAnalyticsMinHours').value = '';
                    document.getElementById('filterAnalyticsMaxHours').value = '';
                    document.getElementById('filterAnalyticsOvertime').value = '';
                    document.getElementById('filterAnalyticsSort').value = 'date_desc';
                    document.getElementById('filterAnalyticsQuickRange').value = '';

                    analyticsData.filteredData = analyticsData.timesheets;

                    // Reload with all data
                    loadAnalytics();

                    console.log('‚úÖ All filters cleared');
                } catch (e) {
                    console.error('Error clearing filters:', e);
                }
            }

            // Download Analytics as XLSX (Enhanced)
            async function downloadAnalyticsXLSX() {
                try {
                    const data = analyticsData.filteredData && analyticsData.filteredData.length > 0 ?
                        analyticsData.filteredData :
                        analyticsData.timesheets;

                    if (!data || data.length === 0) {
                        alert('‚ö†Ô∏è No data to export. Please load analytics first.');
                        return;
                    }

                    // Check if XLSX library is loaded
                    if (typeof XLSX === 'undefined') {
                        alert('üì• Loading XLSX library... Click download again after alert closes.');
                        // Load SheetJS library
                        const script = document.createElement('script');
                        script.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
                        script.onload = () => alert('‚úÖ XLSX library loaded. Click download button again.');
                        document.head.appendChild(script);
                        return;
                    }

                    // Prepare data
                    const wsData = [
                        ['Employee', 'Email', 'Date', 'Project', 'Task', 'Start Time', 'End Time', 'Break (min)', 'Total Hours', 'Overtime', 'Status', 'Description']
                    ];

                    data.forEach(ts => {
                        wsData.push([
                            ts.employee?.name || 'Unknown',
                            ts.employee?.email || 'N/A',
                            new Date(ts.date).toLocaleDateString(),
                            ts.project?.name || 'Unassigned',
                            ts.task?.title || ts.task?.name || 'Unassigned',
                            ts.startTime || 'N/A',
                            ts.endTime || 'N/A',
                            ts.breakMinutes || 0,
                            ts.totalHours || 0,
                            ts.overtimeHours || 0,
                            ts.status,
                            ts.description || '-'
                        ]);
                    });

                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(wsData);

                    // Set column widths
                    ws['!cols'] = [{
                        wch: 20
                    }, {
                        wch: 25
                    }, {
                        wch: 12
                    }, {
                        wch: 20
                    }, {
                        wch: 25
                    }, {
                        wch: 10
                    }, {
                        wch: 10
                    }, {
                        wch: 10
                    }, {
                        wch: 10
                    }, {
                        wch: 10
                    }, {
                        wch: 15
                    }, {
                        wch: 40
                    }];

                    XLSX.utils.book_append_sheet(wb, ws, 'Analytics');

                    // Download
                    XLSX.writeFile(wb, `analytics_${new Date().toISOString().split('T')[0]}.xlsx`);
                } catch (e) {
                    console.error('Error downloading XLSX:', e);
                    alert('Error generating XLSX file: ' + e.message);
                }
            }

            // Download Analytics as CSV (Enhanced)
            async function downloadAnalyticsCSV() {
                try {
                    const data = analyticsData.filteredData.length > 0 ? analyticsData.filteredData : analyticsData.timesheets;

                    // CSV headers
                    const headers = ['Employee', 'Email', 'Date', 'Project', 'Task', 'Start Time', 'End Time', 'Break (min)', 'Total Hours', 'Overtime', 'Status', 'Description'];

                    // CSV rows
                    const rows = data.map(ts => [
                        ts.employee?.name || 'Unknown',
                        ts.employee?.email || 'N/A',
                        new Date(ts.date).toLocaleDateString(),
                        ts.project?.name || 'Unassigned',
                        ts.task?.title || ts.task?.name || 'Unassigned',
                        ts.startTime || 'N/A',
                        ts.endTime || 'N/A',
                        ts.breakMinutes || 0,
                        ts.totalHours || 0,
                        ts.overtimeHours || 0,
                        ts.status,
                        (ts.description || '-').replace(/"/g, '""') // Escape quotes
                    ]);

                    // Create CSV content
                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');

                    // Download
                    const blob = new Blob([csvContent], {
                        type: 'text/csv;charset=utf-8;'
                    });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error('Error downloading CSV:', e);
                    alert('Error generating CSV file: ' + e.message);
                }
            }

            // Download Analytics as PDF
            async function downloadAnalyticsPDF() {
                try {
                    const data = analyticsData.filteredData.length > 0 ? analyticsData.filteredData : analyticsData.timesheets;

                    // Check if jsPDF library is loaded
                    if (typeof jspdf === 'undefined') {
                        alert('üì• Loading PDF library...');
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                        script.onload = () => {
                            const autoTableScript = document.createElement('script');
                            autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js';
                            autoTableScript.onload = () => downloadAnalyticsPDF();
                            document.head.appendChild(autoTableScript);
                        };
                        document.head.appendChild(script);
                        return;
                    }

                    const {
                        jsPDF
                    } = jspdf;
                    const doc = new jsPDF();

                    // Title
                    doc.setFontSize(18);
                    doc.text('Analytics Report', 14, 22);

                    // Filter summary
                    doc.setFontSize(10);
                    const filterText = document.getElementById('filterSummaryText').textContent || 'No filters applied';
                    doc.text(`Filters: ${filterText}`, 14, 30);
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 36);

                    // Stats summary
                    doc.text(`Total Timesheets: ${document.getElementById('sumTotal').textContent}`, 14, 42);
                    doc.text(`Total Hours: ${document.getElementById('sumHours').textContent}`, 80, 42);
                    doc.text(`Overtime: ${document.getElementById('sumOvertime').textContent}`, 140, 42);

                    // Table
                    const tableData = data.map(ts => [
                        ts.employee?.name || 'Unknown',
                        new Date(ts.date).toLocaleDateString(),
                        ts.project?.name || 'Unassigned',
                        (ts.totalHours || 0) + 'h',
                        (ts.overtimeHours || 0) + 'h',
                        ts.status
                    ]);

                    doc.autoTable({
                        startY: 50,
                        head: [
                            ['Employee', 'Date', 'Project', 'Hours', 'OT', 'Status']
                        ],
                        body: tableData,
                        theme: 'grid',
                        styles: {
                            fontSize: 8
                        }
                    });

                    doc.save(`analytics_${new Date().toISOString().split('T')[0]}.pdf`);
                } catch (e) {
                    console.error('Error generating PDF:', e);
                    alert('Error generating PDF: ' + e.message);
                }
            }

            // Send Analytics to Admin (Enhanced)
            async function sendAnalyticsToAdmin() {
                try {
                    const data = analyticsData.filteredData.length > 0 ? analyticsData.filteredData : analyticsData.timesheets;

                    if (data.length === 0) {
                        alert('‚ö†Ô∏è No data to send. Please load analytics first.');
                        return;
                    }

                    // Get current user info
                    const userResponse = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const userData = await userResponse.json();
                    const currentUser = userData.user || userData;

                    // Get date range from filters or default
                    const startDate = document.getElementById('filterAnalyticsStartDate')?.value || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    const endDate = document.getElementById('filterAnalyticsEndDate')?.value || new Date().toISOString().split('T')[0];

                    // Calculate employee performance
                    const empHours = {};
                    const empCounts = {};
                    data.forEach(ts => {
                        const empId = ts.employee?._id || 'unknown';
                        const empName = ts.employee?.name || 'Unknown';
                        empHours[empId] = empHours[empId] || {
                            name: empName,
                            hours: 0,
                            timesheets: 0
                        };
                        empHours[empId].hours += (ts.totalHours || 0);
                        empHours[empId].timesheets++;
                        empCounts[empId] = (empCounts[empId] || 0) + 1;
                    });

                    const sortedEmployees = Object.entries(empHours)
                        .map(([id, data]) => ({
                            employeeId: id,
                            ...data,
                            avgHours: data.hours / data.timesheets
                        }))
                        .sort((a, b) => b.hours - a.hours);

                    const topPerformers = sortedEmployees.slice(0, 5).map(e => ({
                        name: e.name,
                        score: e.hours,
                        metrics: {
                            totalHours: e.hours,
                            taskCompletionRate: 0,
                            attendanceRate: 0,
                            avgHoursPerDay: parseFloat(e.avgHours.toFixed(2))
                        }
                    }));

                    const bottomPerformers = sortedEmployees.slice(-3).reverse().map(e => ({
                        name: e.name,
                        issues: [`Low timesheet hours (${e.hours}h)`]
                    }));

                    // Calculate project analytics
                    const projHours = {};
                    data.forEach(ts => {
                        const projId = ts.project?._id || 'unassigned';
                        const projName = ts.project?.name || 'Unassigned';
                        projHours[projId] = projHours[projId] || {
                            name: projName,
                            hours: 0,
                            timesheets: 0
                        };
                        projHours[projId].hours += (ts.totalHours || 0);
                        projHours[projId].timesheets++;
                    });

                    const projectHours = Object.entries(projHours)
                        .map(([id, data]) => ({
                            name: data.name,
                            hours: data.hours,
                            percentage: 0
                        }))
                        .sort((a, b) => b.hours - a.hours);

                    const totalProjectHours = projectHours.reduce((sum, p) => sum + p.hours, 0);
                    projectHours.forEach(p => {
                        p.percentage = totalProjectHours > 0 ? parseFloat(((p.hours / totalProjectHours) * 100).toFixed(1)) : 0;
                    });

                    // Status breakdown
                    const statusBreakdown = {};
                    data.forEach(ts => {
                        statusBreakdown[ts.status] = (statusBreakdown[ts.status] || 0) + 1;
                    });

                    // Count unique employees and projects
                    const uniqueEmployees = new Set(data.map(ts => ts.employee?._id).filter(Boolean));
                    const uniqueProjects = new Set(data.map(ts => ts.project?._id).filter(Boolean));

                    // Prepare report data in CORRECT backend format
                    const reportData = {
                        title: `Analytics Report - ${new Date().toLocaleDateString()}`,
                        description: `Comprehensive analytics report covering ${data.length} timesheets from ${uniqueEmployees.size} employees across ${uniqueProjects.size} projects`,
                        reportType: 'team_performance',
                        dateRange: {
                            startDate: new Date(startDate),
                            endDate: new Date(endDate)
                        },
                        data: {
                            timesheets: {
                                total: data.length,
                                approved: data.filter(ts => ts.status === 'approved' || ts.status === 'approved_final').length,
                                pending: data.filter(ts => ts.status.includes('pending')).length,
                                rejected: data.filter(ts => ts.status === 'rejected').length,
                                totalHours: data.reduce((sum, ts) => sum + (ts.totalHours || 0), 0),
                                byEmployee: sortedEmployees.map(e => ({
                                    name: e.name,
                                    count: e.timesheets,
                                    hours: e.hours,
                                    avgHoursPerDay: parseFloat(e.avgHours.toFixed(2))
                                })),
                                byProject: projectHours.map(p => ({
                                    name: p.name,
                                    hours: p.hours,
                                    percentage: p.percentage
                                }))
                            },
                            tasks: {
                                total: 0,
                                completed: 0,
                                inProgress: 0,
                                pending: 0
                            },
                            attendance: {
                                totalDays: 0,
                                presentDays: 0,
                                absentDays: 0,
                                lateDays: 0
                            },
                            leaves: {
                                total: 0,
                                approved: 0,
                                pending: 0,
                                rejected: 0
                            },
                            rankings: {
                                topPerformers: topPerformers,
                                needsImprovement: bottomPerformers
                            }
                        }
                    };

                    console.log('üìä Sending report data in correct format:', reportData);

                    // Create analytics report via API
                    const createResponse = await fetch('/api/analytics-report/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(reportData)
                    });

                    if (!createResponse.ok) {
                        const errorText = await createResponse.text();
                        throw new Error(`Failed to create report: ${errorText}`);
                    }

                    const createResult = await createResponse.json();
                    console.log('üìä Create response:', createResult);
                    const reportId = createResult.reportId || createResult.data?._id || createResult._id;

                    if (!reportId) {
                        console.error('‚ùå No report ID in response:', createResult);
                        throw new Error('Report created but no ID returned');
                    }

                    console.log('‚úÖ Report created with ID:', reportId);

                    // Send report to admins via API
                    const sendResponse = await fetch(`/api/analytics-report/send/${reportId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!sendResponse.ok) {
                        const errorText = await sendResponse.text();
                        throw new Error(`Failed to send report: ${errorText}`);
                    }

                    const sendResult = await sendResponse.json();
                    console.log('‚úÖ Report sent successfully:', sendResult);

                    alert(`‚úÖ Analytics report sent to admin successfully!\n\nüìä Report includes:\n‚Ä¢ ${data.length} timesheets\n‚Ä¢ ${uniqueEmployees.size} employees\n‚Ä¢ ${uniqueProjects.size} projects\n‚Ä¢ ${reportData.data.timesheets.totalHours.toFixed(1)} total hours`);

                } catch (err) {
                    console.error('Error sending report to admin:', err);
                    alert('‚ùå Error sending report: ' + err.message);
                }
            }

            // Schedule Report
            async function scheduleReport() {
                const frequency = prompt('Schedule analytics report:\n\n1. Daily\n2. Weekly\n3. Monthly\n\nEnter your choice (1-3):');

                if (!frequency) return;

                let scheduleText = '';
                switch (frequency) {
                    case '1':
                        scheduleText = 'Daily (every day at 9:00 AM)';
                        break;
                    case '2':
                        scheduleText = 'Weekly (every Monday at 9:00 AM)';
                        break;
                    case '3':
                        scheduleText = 'Monthly (1st of each month at 9:00 AM)';
                        break;
                    default:
                        alert('‚ùå Invalid choice');
                        return;
                }

                // In a real implementation, this would save to backend
                alert(`‚úÖ Report scheduled: ${scheduleText}\n\n(Note: This is a demo. Actual scheduling requires backend implementation with cron jobs.)`);
            }

            // Print Analytics
            function printAnalytics() {
                window.print();
            }

            function logout() {
                localStorage.clear();
                window.location.href = '/login.html';
            }

            // ========== FILTERING FUNCTIONS ==========

            // Store original data for filtering
            let allTimesheets = [];
            let allTasks = [];
            let allLeaves = [];
            let allMeetings = [];
            let allFeedback = [];
            let allEmployees = [];

            // Populate employee filter dropdowns
            async function populateEmployeeFilters() {
                try {
                    // Try to get employees - extract from leaves if admin endpoint fails
                    let employees = [];
                    try {
                        const empResponse = await api('/admin/employees');
                        employees = empResponse?.data || empResponse || [];
                    } catch (e) {
                        // If admin endpoint fails (manager role), extract unique employees from leaves
                        console.log('Getting employees from leave requests');
                        if (allLeaves && allLeaves.length > 0) {
                            const uniqueEmps = new Map();
                            allLeaves.forEach(leave => {
                                if (leave.employee && leave.employee._id) {
                                    uniqueEmps.set(leave.employee._id, leave.employee);
                                }
                            });
                            employees = Array.from(uniqueEmps.values());
                        }
                    }

                    allEmployees = employees;

                    const options = employees.map(emp =>
                        `<option value="${emp._id}">${emp.name || emp.email}</option>`
                    ).join('');

                    document.getElementById('filterTimesheetEmployee').innerHTML = '<option value="">All Employees</option>' + options;
                    document.getElementById('filterTaskEmployee').innerHTML = '<option value="">All Employees</option>' + options;
                    document.getElementById('filterLeaveEmployee').innerHTML = '<option value="">All Employees</option>' + options;
                } catch (e) {
                    console.error('Error loading employees:', e);
                }
            }

            // TIMESHEET FILTERS
            function applyTimesheetFilters() {
                const employeeId = document.getElementById('filterTimesheetEmployee').value;
                const status = document.getElementById('filterTimesheetStatus').value;
                const fromDate = document.getElementById('filterTimesheetFrom').value;
                const toDate = document.getElementById('filterTimesheetTo').value;

                let filtered = allTimesheets;

                if (employeeId) {
                    filtered = filtered.filter(ts => String(ts.employee._id || ts.employee) === employeeId);
                }
                if (status) {
                    filtered = filtered.filter(ts => ts.status === status);
                }
                if (fromDate) {
                    filtered = filtered.filter(ts => new Date(ts.date) >= new Date(fromDate));
                }
                if (toDate) {
                    filtered = filtered.filter(ts => new Date(ts.date) <= new Date(toDate));
                }

                renderTimesheets(filtered);
            }

            function clearTimesheetFilters() {
                document.getElementById('filterTimesheetEmployee').value = '';
                document.getElementById('filterTimesheetStatus').value = '';
                document.getElementById('filterTimesheetFrom').value = '';
                document.getElementById('filterTimesheetTo').value = '';
                renderTimesheets(allTimesheets);
            }

            function renderTimesheets(timesheets) {
                let html = '';
                timesheets.forEach(ts => {
                    html += `<tr>
                    <td>${ts.employee?.name || ts.employee?.email || 'Unknown'}</td>
                    <td>${new Date(ts.date).toLocaleDateString()}</td>
                    <td>${ts.project?.name || '-'}</td>
                    <td>${ts.totalHours}h</td>
                    <td><span class="badge badge-${ts.status === 'approved' ? 'success' : ts.status === 'rejected' ? 'danger' : 'warning'}">${ts.status}</span></td>
                    <td>
                        ${ts.status === 'pending' || ts.status === 'pending_manager' ? `
                            <button class="btn btn-approve btn-sm" onclick="approveTimesheet('${ts._id}')">‚úì Approve</button>
                            <button class="btn btn-reject btn-sm" onclick="rejectTimesheet('${ts._id}')">‚úó Reject</button>
                        ` : '-'}
                    </td>
                </tr>`;
                });
                document.getElementById('pendingList').innerHTML = html || '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üì≠</div><div>No timesheets found</div></td></tr>';
            }

            // TASK FILTERS
            function applyTaskFilters() {
                const employeeId = document.getElementById('filterTaskEmployee').value;
                const searchTerm = document.getElementById('filterTaskSearch').value.toLowerCase();
                const status = document.getElementById('filterTaskStatus').value;

                let filtered = allTasks;

                if (employeeId) {
                    filtered = filtered.filter(review =>
                        String(review.employee?._id || review.employee) === employeeId
                    );
                }
                if (searchTerm) {
                    filtered = filtered.filter(review =>
                        review.title?.toLowerCase().includes(searchTerm) ||
                        review.description?.toLowerCase().includes(searchTerm) ||
                        review.project?.name?.toLowerCase().includes(searchTerm)
                    );
                }
                if (status) {
                    filtered = filtered.filter(review => review.reviewStatus === status);
                }

                renderTasks(filtered);
            }

            function clearTaskFilters() {
                document.getElementById('filterTaskEmployee').value = '';
                document.getElementById('filterTaskSearch').value = '';
                document.getElementById('filterTaskStatus').value = '';
                renderTasks(allTasks);
            }

            function renderTasks(tasks) {
                let html = '';
                tasks.forEach(review => {
                    const githubLink = review.proofSubmission?.githubLink || '#';
                    const videoLink = review.proofSubmission?.demoVideoLink || '#';
                    const notes = review.proofSubmission?.completionNotes || '-';
                    const submittedDate = review.submittedAt ? new Date(review.submittedAt).toLocaleDateString() : '-';
                    const status = review.reviewStatus || 'pending_review';
                    const defectCount = review.defectCount || 0;

                    // Status badge with defect count
                    let statusBadge = '';
                    let actionButtons = '';

                    if (status === 'pending_review') {
                        statusBadge = '<span class="badge badge-warning">‚è≥ Pending Review</span>';
                        actionButtons = `
                        <button class="btn btn-approve btn-sm" onclick="reviewTask('${review.taskId}', '${review.employee._id}', 'approve')">‚úÖ Approve</button>
                        <button class="btn btn-sm" style="background:#f39c12;color:white;" onclick="sendForRework('${review.taskId}', '${review.employee._id}')">üîÑ Rework</button>
                        <button class="btn btn-danger btn-sm" onclick="reviewTask('${review.taskId}', '${review.employee._id}', 'reject')">‚ùå Reject</button>
                    `;
                    } else if (status === 'approved' || status === 'completed') {
                        statusBadge = `<span class="badge badge-success">‚úÖ Approved</span>`;
                        actionButtons = `<button class="btn btn-sm" style="background:#e67e22;color:white;padding:4px 8px;" onclick="sendForRework('${review.taskId}', '${review.employee._id}')">üîß Report Defect</button>`;
                    } else if (status === 'rework_required') {
                        statusBadge = `<span class="badge badge-warning">üîÑ Rework Required</span>${defectCount > 0 ? `<br><small style="color:#e67e22;">Cycle ${defectCount}</small>` : ''}`;
                        actionButtons = '<span style="color:#f39c12;">Awaiting resubmission</span>';
                    } else if (status === 'rejected') {
                        statusBadge = '<span class="badge badge-danger">‚ùå Rejected</span>';
                        actionButtons = '-';
                    }

                    html += `<tr>
                    <td>${review.employee?.name || review.employee?.email || 'Unknown'}</td>
                    <td><strong>${review.title}</strong><br><small>${review.project?.name || ''}</small><br>${statusBadge}</td>
                    <td><a href="${githubLink}" target="_blank" class="btn btn-sm" style="background:#333;color:#fff;">üìÇ GitHub</a></td>
                    <td><a href="${videoLink}" target="_blank" class="btn btn-sm" style="background:#c4302b;color:#fff;">üé• Video</a></td>
                    <td style="max-width:200px;white-space:normal;">${notes}</td>
                    <td>${submittedDate}</td>
                    <td>${actionButtons}</td>
                </tr>`;
                });
                document.getElementById('taskReviewsList').innerHTML = html || '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No task reviews found</div></td></tr>';
            }

            // LEAVE FILTERS
            function applyLeaveFilters() {
                const employeeId = document.getElementById('filterLeaveEmployee').value;
                const leaveType = document.getElementById('filterLeaveType').value;
                const status = document.getElementById('filterLeaveStatus').value;

                let filtered = allLeaves;

                if (employeeId) {
                    filtered = filtered.filter(leave => {
                        const empId = leave.employee?._id || leave.employee;
                        return String(empId) === String(employeeId);
                    });
                }
                if (leaveType) {
                    filtered = filtered.filter(leave => leave.leaveType === leaveType);
                }
                if (status) {
                    filtered = filtered.filter(leave => leave.status === status);
                }

                renderLeaves(filtered);
            }

            function clearLeaveFilters() {
                document.getElementById('filterLeaveEmployee').value = '';
                document.getElementById('filterLeaveType').value = '';
                document.getElementById('filterLeaveStatus').value = '';
                renderLeaves(allLeaves);
            }

            function renderLeaves(leaves) {
                let html = '';
                leaves.forEach(leave => {
                    const fromDate = leave.fromDate ? new Date(leave.fromDate).toLocaleDateString() : '-';
                    const toDate = leave.toDate ? new Date(leave.toDate).toLocaleDateString() : '-';
                    const duration = leave.leaveType === 'PERMISSION' ? `${leave.permissionHours || 0}h` : `${leave.totalDays || 0} days`;

                    html += `<tr>
                    <td>${leave.employee?.name || leave.employee?.email || 'Unknown'}</td>
                    <td><span class="badge badge-info">${leave.leaveType || 'N/A'}</span></td>
                    <td>${fromDate}</td>
                    <td>${toDate}</td>
                    <td>${duration}</td>
                    <td style="max-width:200px;white-space:normal;">${leave.reason || '-'}</td>
                    <td>
                        ${leave.status === 'pending' ? `
                            <button class="btn btn-approve btn-sm" onclick="approveLeave('${leave._id}')">‚úì Approve</button>
                            <button class="btn btn-reject btn-sm" onclick="rejectLeave('${leave._id}')">‚úó Reject</button>
                        ` : `<span class="badge badge-${leave.status === 'approved' ? 'success' : 'danger'}">${leave.status}</span>`}
                    </td>
                </tr>`;
                });
                document.getElementById('leaveRequestsList').innerHTML = html || '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üèñÔ∏è</div><div>No leave requests found</div></td></tr>';
            }

            // MEETING FILTERS
            function applyMeetingFilters() {
                const status = document.getElementById('filterMeetingStatus').value;
                const fromDate = document.getElementById('filterMeetingFrom').value;
                const toDate = document.getElementById('filterMeetingTo').value;
                const searchTerm = document.getElementById('filterMeetingSearch').value.toLowerCase();

                let filtered = allMeetings;

                if (status) {
                    filtered = filtered.filter(meeting => meeting.status === status);
                }
                if (fromDate) {
                    filtered = filtered.filter(meeting => new Date(meeting.scheduledTime) >= new Date(fromDate));
                }
                if (toDate) {
                    filtered = filtered.filter(meeting => new Date(meeting.scheduledTime) <= new Date(toDate));
                }
                if (searchTerm) {
                    filtered = filtered.filter(meeting =>
                        meeting.title?.toLowerCase().includes(searchTerm) ||
                        meeting.description?.toLowerCase().includes(searchTerm)
                    );
                }

                renderMeetings(filtered);
            }

            function clearMeetingFilters() {
                document.getElementById('filterMeetingStatus').value = '';
                document.getElementById('filterMeetingFrom').value = '';
                document.getElementById('filterMeetingTo').value = '';
                document.getElementById('filterMeetingSearch').value = '';
                renderMeetings(allMeetings);
            }

            function renderMeetings(meetings) {
                let html = '';
                meetings.forEach(meeting => {
                    const dateTime = meeting.dateTime || meeting.scheduledTime || meeting.startTime;
                    const participants = meeting.recipients || meeting.participants || [];
                    const link = meeting.link || meeting.location || '#';
                    const status = meeting.status || 'scheduled';

                    html += `<tr>
                    <td>${meeting.title}</td>
                    <td>${new Date(dateTime).toLocaleString()}</td>
                    <td>${participants.length}</td>
                    <td><a href="${link}" target="_blank">Join</a></td>
                    <td><span class="badge badge-${status === 'completed' ? 'success' : 'info'}">${status}</span></td>
                    <td>
                        ${status === 'scheduled' ? `
                            <button class="btn btn-reject btn-sm" onclick="cancelMeeting('${meeting._id}')">Cancel</button>
                        ` : '-'}
                    </td>
                </tr>`;
                });
                document.getElementById('meetingsList').innerHTML = html || '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìÖ</div><div>No meetings found</div></td></tr>';
            }

            // FEEDBACK FILTERS
            function applyFeedbackFilters() {
                const category = document.getElementById('filterFeedbackCategory').value;
                const priority = document.getElementById('filterFeedbackPriority').value;
                const status = document.getElementById('filterFeedbackStatus').value;
                const searchTerm = document.getElementById('filterFeedbackSearch').value.toLowerCase();

                let filtered = allFeedback;

                if (category) {
                    filtered = filtered.filter(thread => thread.category === category);
                }
                if (priority) {
                    filtered = filtered.filter(thread => thread.priority === priority);
                }
                if (status) {
                    filtered = filtered.filter(thread => thread.status === status);
                }
                if (searchTerm) {
                    filtered = filtered.filter(thread =>
                        thread.subject?.toLowerCase().includes(searchTerm)
                    );
                }

                renderFeedback(filtered);
            }

            function clearFeedbackFilters() {
                document.getElementById('filterFeedbackCategory').value = '';
                document.getElementById('filterFeedbackPriority').value = '';
                document.getElementById('filterFeedbackStatus').value = '';
                document.getElementById('filterFeedbackSearch').value = '';
                renderFeedback(allFeedback);
            }

            function renderFeedback(threads) {
                console.log('üìã Rendering', threads.length, 'feedback threads');

                if (!threads || threads.length === 0) {
                    document.getElementById('feedbackThreadsList').innerHTML =
                        '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üí¨</div><div>No feedback threads found</div></td></tr>';
                    return;
                }

                let html = '';
                threads.forEach(thread => {
                    const senderName = thread.sender?.name || 'Unknown';
                    const receiverName = thread.receiver?.name || 'Unknown';

                    html += `<tr>
                    <td>#${thread._id.slice(-6)}</td>
                    <td>${thread.title}</td>
                    <td><span class="badge badge-info">${thread.tag || 'General'}</span></td>
                    <td><span class="badge badge-info">-</span></td>
                    <td><span class="badge badge-${thread.status === 'resolved' ? 'success' : thread.status === 'closed' ? 'danger' : 'warning'}">${thread.status}</span></td>
                    <td>From: ${senderName}<br>To: ${receiverName}</td>
                    <td>${thread.lastMessageAt ? new Date(thread.lastMessageAt).toLocaleString() : '-'}</td>
                    <td>
                        <button class="btn btn-approve btn-sm" onclick="viewThread('${thread._id}')">View</button>
                    </td>
                </tr>`;
                });
                document.getElementById('feedbackThreadsList').innerHTML = html;
            }

            // ========== END FILTERING FUNCTIONS ==========

            // ========== PROJECT COMPLETION MANAGEMENT ==========

            async function loadProjects() {
                try {
                    const response = await api('/project-completion/my-projects');
                    const projects = response.data || response || [];

                    // Update stats
                    document.getElementById('totalProjectsCount').textContent = projects.length;
                    document.getElementById('pendingReviewCount').textContent =
                        projects.filter(p => p.status === 'pending_review').length;
                    document.getElementById('reworkRequiredCount').textContent =
                        projects.filter(p => p.status === 'rework_required').length;
                    document.getElementById('approvedProjectsCount').textContent =
                        projects.filter(p => p.status === 'approved').length;

                    renderProjects(projects);
                } catch (err) {
                    console.error('Load projects error:', err);
                    alert('‚ùå Failed to load projects');
                }
            }

            function renderProjects(projects) {
                if (!projects || projects.length === 0) {
                    document.getElementById('projectsList').innerHTML =
                        '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üì¶</div><div>No projects found</div></td></tr>';
                    return;
                }

                let html = '';
                projects.forEach(proj => {
                    const startDate = proj.startDate ? new Date(proj.startDate).toLocaleDateString() : 'N/A';
                    const endDate = proj.endDate ? new Date(proj.endDate).toLocaleDateString() : 'N/A';
                    const defectCount = proj.defectCount || 0;

                    let statusBadge = '';
                    switch (proj.status) {
                        case 'active':
                            statusBadge = '<span class="badge badge-info">Active</span>';
                            break;
                        case 'pending_review':
                            statusBadge = '<span class="badge badge-warning">Pending Review</span>';
                            break;
                        case 'rework_required':
                            statusBadge = '<span class="badge badge-danger">Rework Required</span>';
                            break;
                        case 'approved':
                            statusBadge = '<span class="badge badge-success">‚úÖ Approved</span>';
                            break;
                        case 'completed':
                            statusBadge = '<span class="badge badge-success">Completed</span>';
                            break;
                        default:
                            statusBadge = `<span class="badge">${proj.status}</span>`;
                    }

                    let reviewBadge = '';
                    if (proj.reviewCycle && proj.reviewCycle.reviewStatus) {
                        switch (proj.reviewCycle.reviewStatus) {
                            case 'pending':
                                reviewBadge = '<span class="badge badge-warning">‚è≥ Pending</span>';
                                break;
                            case 'approved':
                                reviewBadge = '<span class="badge badge-success">‚úÖ Approved</span>';
                                break;
                            case 'rework_required':
                                reviewBadge = '<span class="badge badge-danger">üîÑ Rework</span>';
                                break;
                            case 'rejected':
                                reviewBadge = '<span class="badge badge-danger">‚ùå Rejected</span>';
                                break;
                        }
                    } else {
                        reviewBadge = '<span class="badge">Not Submitted</span>';
                    }

                    let actionButtons = '';
                    if (proj.canSubmitProof) {
                        if (proj.needsRework && proj.reviewCycle?.defectDescription) {
                            actionButtons = `
                            <button class="btn btn-sm btn-warning" onclick="viewDefects('${proj.projectId}')">
                                üîç View Defects
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="submitCompletionProof('${proj.projectId}', '${proj.name}')">
                                üì§ Resubmit Proof
                            </button>
                        `;
                        } else {
                            actionButtons = `
                            <button class="btn btn-sm btn-primary" onclick="submitCompletionProof('${proj.projectId}', '${proj.name}')">
                                üì§ Submit Completion
                            </button>
                        `;
                        }
                    } else if (proj.status === 'pending_review') {
                        actionButtons = '<span style="color: #95a5a6;">Awaiting Admin Review</span>';
                    } else if (proj.status === 'approved') {
                        actionButtons = '<span style="color: #27ae60;">‚úÖ Approved by Admin</span>';
                    } else {
                        actionButtons = '<span style="color: #7f8c8d;">-</span>';
                    }

                    html += `
                <tr>
                    <td><strong>${proj.name}</strong><br><small style="color: #7f8c8d;">${proj.description || ''}</small></td>
                    <td>${statusBadge}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td>${reviewBadge}</td>
                    <td>${defectCount > 0 ? `<span class="badge badge-danger">${defectCount}</span>` : '-'}</td>
                    <td>${actionButtons}</td>
                </tr>`;
                });

                document.getElementById('projectsList').innerHTML = html;
            }

            async function submitCompletionProof(projectId, projectName) {
                const githubLink = prompt(`üì¶ Submit Completion Proof for: ${projectName}\n\nüîó GitHub Repository Link:`);
                if (!githubLink || githubLink.trim() === '') {
                    alert('‚ùå GitHub link is required');
                    return;
                }

                const demoVideoLink = prompt('üé• Demo Video Link (YouTube, Loom, etc):\n(Optional - press Cancel to skip)');
                const documentationLink = prompt('üìÑ Documentation Link (Google Docs, Notion, etc):\n(Optional - press Cancel to skip)');
                const completionNotes = prompt('üìù Completion Notes:\nDescribe what was accomplished, features implemented, etc.\n(Optional)');

                if (!confirm(`Submit completion proof for "${projectName}"?\n\nThis will notify admins for review.`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/project-completion/submit/${projectId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            githubLink: githubLink.trim(),
                            demoVideoLink: demoVideoLink?.trim() || null,
                            documentationLink: documentationLink?.trim() || null,
                            completionNotes: completionNotes?.trim() || null
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('‚úÖ ' + data.message);
                        loadProjects(); // Reload
                    } else {
                        alert('‚ùå ' + (data.message || 'Failed to submit proof'));
                    }
                } catch (err) {
                    console.error('Submit proof error:', err);
                    alert('‚ùå Failed to submit proof');
                }
            }

            async function viewDefects(projectId) {
                try {
                    const response = await api('/project-completion/my-projects');
                    const projects = response.data || response || [];
                    const project = projects.find(p => String(p.projectId) === String(projectId));

                    if (!project || !project.reviewCycle) {
                        alert('‚ùå Defect details not found');
                        return;
                    }

                    const defectInfo = `
üì¶ Project: ${project.name}

üîß Defect Description:
${project.reviewCycle.defectDescription || 'No description provided'}

üí¨ Admin Comments:
${project.reviewCycle.adminComments || 'No comments'}

üîÑ Defect Count: ${project.reviewCycle.defectCount || 0}

üìÖ Reviewed At: ${project.reviewCycle.reviewedAt ? new Date(project.reviewCycle.reviewedAt).toLocaleString() : 'N/A'}

‚ö†Ô∏è Please fix the issues and resubmit your completion proof.
                `;

                    alert(defectInfo);
                } catch (err) {
                    console.error('View defects error:', err);
                    alert('‚ùå Failed to load defect details');
                }
            }

            // ========== END PROJECT MANAGEMENT ==========

            // ========== ANALYTICS REPORTS TO ADMIN ==========
            async function loadMyReports() {
                try {
                    const response = await fetch('/api/analytics-report/my-reports', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const reports = await response.json();

                    const container = document.getElementById('reportsContainer');

                    if (reports.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">No reports created yet. Click "Create New Report" to get started.</p>';
                        return;
                    }

                    container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Date Range</th>
                                <th>Status</th>
                                <th>Sent At</th>
                                <th>Admin Viewed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reports.map(r => `
                                <tr>
                                    <td><strong>${r.title}</strong></td>
                                    <td><span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${r.reportType.replace('_', ' ').toUpperCase()}</span></td>
                                    <td>${new Date(r.dateRange.startDate).toLocaleDateString()} - ${new Date(r.dateRange.endDate).toLocaleDateString()}</td>
                                    <td>
                                        <span class="status status-${r.status}" style="padding: 4px 10px; border-radius: 5px; font-size: 12px;">
                                            ${r.status === 'sent' ? 'üì§ Sent' : r.status === 'viewed' ? 'üëÄ Viewed' : r.status === 'downloaded' ? 'üíæ Downloaded' : 'üìù Draft'}
                                        </span>
                                    </td>
                                    <td>${r.sentAt ? new Date(r.sentAt).toLocaleString() : '-'}</td>
                                    <td>${r.viewedByAdmin ? `‚úÖ ${new Date(r.viewedAt).toLocaleString()}` : '‚è≥ Not yet'}</td>
                                    <td>
                                        <button onclick="viewReportDetails('${r._id}')" class="btn-small" style="background: #3498db; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View</button>
                                        ${r.status === 'draft' ? `<button onclick="deleteReport('${r._id}')" class="btn-small" style="background: #e74c3c; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px;">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                } catch (err) {
                    console.error('Load reports error:', err);
                    document.getElementById('reportsContainer').innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 40px;">Failed to load reports</p>';
                }
            }

            function openCreateReportModal() {
                document.getElementById('createReportModal').style.display = 'flex';
                // Set default dates (last 30 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);

                document.querySelector('input[name="endDate"]').value = endDate.toISOString().split('T')[0];
                document.querySelector('input[name="startDate"]').value = startDate.toISOString().split('T')[0];
            }

            function closeCreateReportModal() {
                document.getElementById('createReportModal').style.display = 'none';
                document.getElementById('createReportForm').reset();
            }

            async function createAnalyticsReport(event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const reportData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    reportType: formData.get('reportType'),
                    dateRange: {
                        startDate: formData.get('startDate'),
                        endDate: formData.get('endDate')
                    }
                };

                try {
                    // Step 1: Create report
                    const createResponse = await fetch('/api/analytics-report/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(reportData)
                    });

                    const createData = await createResponse.json();

                    if (!createResponse.ok) {
                        alert('‚ùå ' + (createData.message || 'Failed to create report'));
                        return;
                    }

                    const reportId = createData.reportId;

                    // Step 2: Generate report data
                    const generateResponse = await fetch(`/api/analytics-report/generate/${reportId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const generateData = await generateResponse.json();

                    if (!generateResponse.ok) {
                        alert('‚ùå ' + (generateData.message || 'Failed to generate report data'));
                        return;
                    }

                    // Step 3: Send to admin
                    const sendResponse = await fetch(`/api/analytics-report/send/${reportId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const sendData = await sendResponse.json();

                    if (!sendResponse.ok) {
                        alert('‚ùå ' + (sendData.message || 'Failed to send report'));
                        return;
                    }

                    alert('‚úÖ Report generated and sent to admin successfully!');
                    closeCreateReportModal();
                    loadMyReports();

                } catch (err) {
                    console.error('Create report error:', err);
                    alert('‚ùå Failed to create and send report');
                }
            }

            async function viewReportDetails(reportId) {
                document.getElementById('viewReportModal').style.display = 'flex';
                document.getElementById('reportDetailsContainer').innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">Loading report details...</p>';

                try {
                    const response = await fetch(`/api/analytics-report/admin/view/${reportId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const report = await response.json();

                    if (!response.ok) {
                        throw new Error(report.message);
                    }

                    const container = document.getElementById('reportDetailsContainer');
                    container.innerHTML = `
                    <div style="padding: 20px;">
                        <h3>${report.title}</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">${report.description || 'No description'}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 8px;">
                                <strong>Report Type:</strong><br>
                                ${report.reportType.replace('_', ' ').toUpperCase()}
                            </div>
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 8px;">
                                <strong>Date Range:</strong><br>
                                ${new Date(report.dateRange.startDate).toLocaleDateString()} - ${new Date(report.dateRange.endDate).toLocaleDateString()}
                            </div>
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 8px;">
                                <strong>Status:</strong><br>
                                ${report.status.toUpperCase()}
                            </div>
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 8px;">
                                <strong>Sent At:</strong><br>
                                ${new Date(report.sentAt).toLocaleString()}
                            </div>
                        </div>
                        
                        <h4>üìä Summary Statistics</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${report.data.timesheets.total}</div>
                                <div style="font-size: 12px;">Total Timesheets</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${report.data.tasks.total}</div>
                                <div style="font-size: 12px;">Total Tasks</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${report.data.attendance.totalDays}</div>
                                <div style="font-size: 12px;">Attendance Days</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${report.data.timesheets.totalHours.toFixed(1)}</div>
                                <div style="font-size: 12px;">Total Hours</div>
                            </div>
                        </div>
                        
                        <h4>üèÜ Top Performers (Top 5)</h4>
                        <table style="margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Employee</th>
                                    <th>Score</th>
                                    <th>Task Completion</th>
                                    <th>Attendance</th>
                                    <th>Avg Hours/Day</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${report.data.rankings.topPerformers.slice(0, 5).map((p, idx) => `
                                    <tr>
                                        <td><strong>${idx + 1}</strong></td>
                                        <td>${p.name}</td>
                                        <td><span style="background: #27ae60; color: white; padding: 4px 10px; border-radius: 5px; font-weight: bold;">${p.score}%</span></td>
                                        <td>${p.metrics.taskCompletionRate}%</td>
                                        <td>${p.metrics.attendanceRate}%</td>
                                        <td>${p.metrics.avgHoursPerDay} hrs</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        ${report.data.rankings.needsImprovement.length > 0 ? `
                            <h4>‚ö†Ô∏è Needs Improvement</h4>
                            <table style="margin-bottom: 20px;">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.data.rankings.needsImprovement.map(emp => `
                                        <tr>
                                            <td>${emp.name}</td>
                                            <td>${emp.issues.join(', ')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : ''}
                        
                        <div class="action-buttons">
                            <button onclick="closeViewReportModal()" class="btn btn-reject">Close</button>
                        </div>
                    </div>
                `;

                } catch (err) {
                    console.error('View report error:', err);
                    document.getElementById('reportDetailsContainer').innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 40px;">Failed to load report details</p>';
                }
            }

            function closeViewReportModal() {
                document.getElementById('viewReportModal').style.display = 'none';
            }

            async function deleteReport(reportId) {
                if (!confirm('Are you sure you want to delete this report?')) return;

                try {
                    const response = await fetch(`/api/analytics-report/${reportId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('‚úÖ Report deleted successfully');
                        loadMyReports();
                    } else {
                        alert('‚ùå ' + (data.message || 'Failed to delete report'));
                    }
                } catch (err) {
                    console.error('Delete report error:', err);
                    alert('‚ùå Failed to delete report');
                }
            }
            // ========== END ANALYTICS REPORTS ==========

            // ===== PROFILE FUNCTIONS =====
            async function loadProfile() {
                try {
                    const response = await api('/auth/me');
                    const user = response.user || response;

                    // Update profile card
                    document.getElementById('profileName').textContent = user.name || 'User';
                    document.getElementById('profileRole').textContent = user.role || '-';
                    document.getElementById('profileDepartment').textContent = user.department || '-';
                    document.getElementById('profileEmail').textContent = user.email || '-';

                    // Set avatar initial
                    const initial = (user.name || 'U').charAt(0).toUpperCase();
                    document.getElementById('profileAvatar').textContent = initial;

                    // Fill edit form
                    document.getElementById('editName').value = user.name || '';
                    document.getElementById('editPhone').value = user.phone || '';
                    document.getElementById('editDOB').value = user.dob ? user.dob.split('T')[0] : '';
                    document.getElementById('editAddress').value = user.address || '';
                    document.getElementById('editDesignation').value = user.designation || '';
                    document.getElementById('editDepartment').value = user.department || '';
                    document.getElementById('editGithub').value = user.github || '';
                    document.getElementById('editLinkedin').value = user.linkedin || '';
                    document.getElementById('editBio').value = user.bio || '';
                } catch (e) {
                    console.error('Error loading profile:', e);
                }
            }

            async function updateProfile(event) {
                event.preventDefault();

                try {
                    const updates = {
                        name: document.getElementById('editName').value,
                        phone: document.getElementById('editPhone').value,
                        dob: document.getElementById('editDOB').value,
                        address: document.getElementById('editAddress').value,
                        designation: document.getElementById('editDesignation').value,
                        github: document.getElementById('editGithub').value,
                        linkedin: document.getElementById('editLinkedin').value,
                        bio: document.getElementById('editBio').value
                    };

                    const res = await fetch('/api/users/profile', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });

                    if (res.ok) {
                        alert('‚úÖ Profile updated successfully!');
                        loadProfile();
                    } else {
                        const error = await res.json();
                        alert('‚ùå Error: ' + (error.message || 'Failed to update profile'));
                    }
                } catch (e) {
                    console.error('Error updating profile:', e);
                    alert('‚ùå Error: ' + e.message);
                }
            }

            async function changePassword(event) {
                event.preventDefault();

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    alert('‚ùå New passwords do not match!');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('‚ùå Password must be at least 6 characters!');
                    return;
                }

                try {
                    const res = await fetch('/api/auth/change-password', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            currentPassword,
                            newPassword
                        })
                    });

                    if (res.ok) {
                        alert('‚úÖ Password changed successfully!');
                        document.getElementById('passwordForm').reset();
                    } else {
                        const error = await res.json();
                        alert('‚ùå Error: ' + (error.message || 'Failed to change password'));
                    }
                } catch (e) {
                    console.error('Error changing password:', e);
                    alert('‚ùå Error: ' + e.message);
                }
            }

            // Initial load
            populateEmployeeFilters();
            loadTimesheets();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                switch (currentTab) {
                    case 'timesheets': loadTimesheets(); break;
                    case 'tasks': loadTaskReviews(); loadAdditionalStats(); break;
                    case 'projects': loadProjects(); loadAdditionalStats(); break;
                    case 'attendance': loadTodayAttendance(); loadAdditionalStats(); break;
                    case 'leaves': loadLeaveRequests(); loadAdditionalStats(); break;
                    case 'meetings': loadMeetings(); loadAdditionalStats(); break;
                    case 'feedback': loadFeedbackThreads(); break;
                    case 'reports': loadMyReports(); break;
                }
            }, 30000);
        </script>

        <!-- AI Chatbot -->
        <link rel="stylesheet" href="chatbot.css">
        <script src="chatbot-actions.js"></script>
        <script src="chatbot.js"></script>
</body>

</html>